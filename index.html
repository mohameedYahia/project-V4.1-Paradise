<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>بوابة إدارة المشاريع</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <!-- SheetJS for Excel Export/Import -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <!-- Mammoth.js for DOCX import -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.16/mammoth.browser.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Cairo', sans-serif;
            background-color: #f8f9fa;
        }
        /* Login Page styles */
        .login-bg { 
            background-color: #f8f9fa;
            position: relative;
            overflow: hidden;
        }

        .login-bg::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: url('images/logoBlack.png');
            background-repeat: no-repeat;
            background-position: center;
            background-size: 50%;
            opacity: 0.5;
            z-index: 1.5;
        }
       
        .login-card {
            background-color: rgba(74, 92, 82, 0.9);
            backdrop-filter: blur(4px);
            position: relative;
            z-index: 1;
        }

        .user-type-btn.active {
            background-color: #F2E3B3;
            color: #4A5C52;
            font-weight: bold;
        }
       
        /* Portal Page styles */
        :root {
            --olive-dark: #3D4A3A;
            --gold-accent: #DAA520;
            --sidebar-bg: #111827;
            --sidebar-text: #d1d5db;
            --sidebar-hover-bg: #1f2937;
            --sidebar-active-bg: #374151; 
        }
       
        .portal-theme-text { color: var(--olive-dark); }
        .nav-link.active {
            background-color: var(--sidebar-active-bg);
            color: white;
            border-right: 4px solid var(--gold-accent);
        }
        .nav-parent-button.active {
            background-color: var(--sidebar-active-bg);
            color: white;
        }
        .chart-container {
            position: relative;
            width: 100%;
            height: 320px;
        }
        .modal-backdrop { 
            transition: opacity 0.3s ease;
            perspective: 1000px;
        }
        .modal-content { 
            transition: transform 0.4s cubic-bezier(0.25, 1, 0.5, 1), opacity 0.4s ease;
            transform-style: preserve-3d;
        }
        .modal-backdrop.hidden .modal-content {
            opacity: 0;
            transform: scale(0.9) rotateY(15deg);
        }
       
        .sidebar {
            background: linear-gradient(to bottom, #2c3e50, #1a2920);
            transition: transform 0.3s ease-in-out;
        }
        .rotate-180 {
            transform: rotate(180deg);
        }
        .submenu {
            background-color: rgba(0,0,0,0.2);
        }
        .input-method-btn.active {
            border-color: var(--gold-accent);
            color: var(--olive-dark);
            background-color: #fefce8;
        }
        .icon-3d {
             text-shadow: 1px 1px 3px rgba(0,0,0,0.3);
        }
        .avatar-3d {
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.3), 0 4px 6px rgba(0,0,0,0.2);
        }
        .project-accordion-content, .proj-type-accordion-content {
            max-height: 1000px; /* A large value for transition */
            transition: max-height 0.5s ease-in-out, padding 0.5s ease-in-out, opacity 0.3s ease-in-out 0.1s;
            overflow: hidden;
        }
        .project-accordion-content.hidden, .proj-type-accordion-content.hidden {
            max-height: 0;
            padding-top: 0;
            padding-bottom: 0;
            opacity: 0;
        }

        .step-choice-btn, .functional-card, .nav-link-card {
            transition: all 0.2s ease-in-out;
        }
        .step-choice-btn:hover, .functional-card:hover, .nav-link-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.1);
        }
        .data-table td, .data-table th, .boq-table td, .boq-table th {
            padding: 12px 8px;
            border: 1px solid #ddd;
            text-align: right;
            vertical-align: middle;
            white-space: nowrap;
        }
        .data-table th, .boq-table th {
             white-space: nowrap;
        }
         .boq-template-table td, .boq-template-table th {
            width: auto; /* Let browser decide width */
        }
        .boq-template-table td input {
             min-width: 100px; /* Minimum width for inputs */
        }
        .boq-template-table th:nth-child(4), .boq-template-table td:nth-child(4) {
             white-space: normal; /* Allow scope to wrap */
             min-width: 250px;
        }


        .data-table input, .data-table select, .data-table textarea, .boq-table input {
            width: 100%;
            border: 1px solid #ccc;
            padding: 6px;
            border-radius: 4px;
            background-color: transparent;
            transition: all 0.2s ease;
        }
        .data-table input:focus, .data-table select:focus, .data-table textarea:focus, .boq-table input:focus {
            outline: 1px solid var(--gold-accent);
            background-color: #fefce8;
            border-color: var(--gold-accent);
        }
        .boq-template-table input {
            text-align: right;
        }
        .boq-template-table input.readonly {
            background-color: #f3f4f6;
            cursor: not-allowed;
        }
        @keyframes jiggle {
            0%, 100% { transform: rotate(0); }
            10% { transform: rotate(-10deg); }
            20% { transform: rotate(10deg); }
            30% { transform: rotate(-10deg); }
            40% { transform: rotate(10deg); }
            50% { transform: rotate(0); }
        }
        .jiggle { animation: jiggle 0.6s ease-in-out; }
        mark {
            background-color: #fef08a;
            padding: 0 2px;
            border-radius: 2px;
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>
</head>
<body class="text-gray-800">

    <!-- Login Page (Unchanged) -->
    <div id="login-page" class="login-bg min-h-screen flex flex-col items-center justify-center p-4">
        <div class="w-full max-w-md login-card rounded-2xl p-8 shadow-2xl">
            <header class="mb-6">
                <div class="flex justify-between items-center mb-6">
                    <div class="h-16 w-16 bg-white/20 rounded-full flex items-center justify-center">
                         <img src="images/logoBlack.png" alt="شعار" class="rounded-full opacity-100" onerror="this.onerror=null;this.src='https://placehold.co/80x80/ffffff/4A5C52?text=شعار';">
                    </div>
                    <div class="text-center text-white">
                        <h1 class="text-xl font-bold">وزارة الداخلية</h1>
                        <h2 class="text-2xl font-extrabold">المديرية العامة للسجون</h2>
                        <p class="text-sm">الشؤون الفنية - الدراسات والتصاميم</p>
                    </div>
                    <div class="h-16 w-16 bg-white/20 rounded-full flex items-center justify-center">
                         <img src="images/sudia.png" alt="شعار" class="rounded-full opacity-100" onerror="this.onerror=null;this.src='https://placehold.co/80x80/ffffff/4A5C52?text=شعار';">
                    </div>
                </div>
                 <div class="flex justify-center gap-2 max-w-sm mx-auto">
                    <button class="user-type-btn w-full p-2 rounded-lg bg-white/10 text-white transition" data-user="admin">الإدارة</button>
                    <button class="user-type-btn active w-full p-2 rounded-lg bg-white/10 text-white transition" data-user="user">المستخدم</button>
                </div>
            </header>
            <main>
                <div class="text-center text-white mb-6">
                    <h3 class="text-2xl font-bold">تسجيل الدخول</h3>
                    <p class="text-sm opacity-80">تسجيل الدخول للوصول إلى حسابك</p>
                </div>
                <form id="login-form" class="space-y-5">
                    <div class="relative">
                        <input type="text" id="username" placeholder="اسم المستخدم أو البريد الإلكتروني" required class="w-full bg-white/10 text-white placeholder-white/70 p-3 pr-10 rounded-lg border-2 border-transparent focus:border-[#F2E3B3] focus:outline-none transition">
                        <span class="absolute right-3 top-1/2 -translate-y-1/2 text-white/70">👤</span>
                    </div>
                    <div class="relative">
                        <input type="password" id="password" placeholder="كلمة المرور" required class="w-full bg-white/10 text-white placeholder-white/70 p-3 pr-10 rounded-lg border-2 border-transparent focus:border-[#F2E3B3] focus:outline-none transition">
                         <span class="absolute right-3 top-1/2 -translate-y-1/2 text-white/70">🔒</span>
                    </div>
                    <div class="flex justify-between items-center text-sm text-white">
                        <div class="flex items-center gap-2">
                            <input type="checkbox" id="remember" class="form-checkbox h-4 w-4 rounded bg-white/30 text-[#F2E3B3] focus:ring-0">
                            <label for="remember">تذكرني</label>
                        </div>
                        <a href="#" class="hover:underline">هل نسيت كلمة السر؟</a>
                    </div>
                    <div><button type="submit" class="w-full bg-[#F2E3B3] text-[#4A5C52] font-bold p-3 rounded-lg hover:bg-opacity-90 transition">تسجيل الدخول</button></div>
                </form>
            </main>
        </div>
    </div>
   
    <!-- Portal Page -->
    <div id="portal-page" class="hidden">
        <div class="flex h-screen bg-gray-100">
            <!-- Sidebar -->
            <aside id="sidebar" class="sidebar w-64 fixed top-0 right-0 h-full z-30 md:relative md:translate-x-0 transform translate-x-full">
                 <div class="p-4 border-b border-gray-700 text-center flex items-center justify-center gap-2">
                    <img src="images/logoBlack.png" alt="شعار المؤسسة" class="w-25 h-14 rounded-full" onerror="this.onerror=null;this.src='https://placehold.co/100x60/ffffff/4A5C52?text=شعار';">
                    <h2 class="text-xl font-bold text-white">واجهة البرنامج</h2>
                </div>
                <nav class="mt-4">
                    <p class="px-4 text-xs text-gray-500 uppercase font-semibold">القائمة الرئيسية</p>
                    <a href="#" class="nav-link flex items-center px-4 py-3 mt-2 text-gray-300 hover:bg-gray-700 hover:text-white" data-page="home">
                        <span class="text-xl icon-3d">🏠</span><span class="mx-3 font-medium">الرئيسية</span>
                    </a>
                    <a href="#" class="nav-link flex items-center px-4 py-3 mt-2 text-gray-300 hover:bg-gray-700 hover:text-white" data-page="dashboard">
                        <span class="text-xl icon-3d">🎛️</span><span class="mx-3 font-medium">لوحة التحكم</span>
                    </a>
                   
                    <div>
                        <button id="projects-dropdown-toggle" class="nav-parent-button w-full flex items-center justify-between px-4 py-3 mt-2 text-gray-300 hover:bg-gray-700 hover:text-white">
                            <span class="flex items-center">
                                <span class="text-xl icon-3d">🏗️</span>
                                <span class="mx-3 font-medium">ادارة المشاريع</span>
                            </span>
                            <svg id="projects-dropdown-arrow" class="w-5 h-5 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </button>
                        <div id="projects-dropdown-menu" class="hidden pt-2 pr-4 space-y-1">
                             <div>
                                <button id="studies-dropdown-toggle" class="nav-parent-button w-full flex items-center justify-between px-4 py-2 text-gray-300 hover:bg-gray-700 hover:text-white rounded-md">
                                    <span class="flex items-center">
                                        <span class="text-lg icon-3d">📐</span>
                                        <span class="mx-3 font-medium text-sm">الدراسات و التصاميم</span>
                                    </span>
                                    <svg id="studies-dropdown-arrow" class="w-4 h-4 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                </button>
                                <div id="studies-dropdown-menu" class="hidden pt-2 pr-6 space-y-1 submenu">
                                    <a href="#" class="nav-link block px-3 py-2 text-sm text-gray-400 hover:bg-gray-700 hover:text-white rounded-md" data-page="projects-sub">المشاريع</a>
                                    <a href="#" class="nav-link block px-3 py-2 text-sm text-gray-400 hover:bg-gray-700 hover:text-white rounded-md" data-page="tendering-sub">طرح المشاريع</a>
                                    <a href="#" class="nav-link block px-3 py-2 text-sm text-gray-400 hover:bg-gray-700 hover:text-white rounded-md" data-page="studies-sub">الدراسات</a>
                                </div>
                             </div>
                            <a href="#" class="nav-link flex items-center px-4 py-2 text-gray-300 hover:bg-gray-700 hover:text-white rounded-md" data-page="engineering-supervision">
                               <span class="text-lg icon-3d">🛠️</span><span class="mx-3 font-medium text-sm">الاشراف الهندسي</span>
                            </a>
                        </div>
                    </div>
                   
                    <a href="#" class="nav-link flex items-center px-4 py-3 mt-2 text-gray-300 hover:bg-gray-700 hover:text-white" data-page="entities">
                        <span class="text-xl icon-3d">🏢</span><span class="mx-3 font-medium">الجهات</span>
                    </a>
                    <a href="#" class="nav-link flex items-center px-4 py-3 mt-2 text-gray-300 hover:bg-gray-700 hover:text-white" data-page="archive">
                        <span class="text-xl icon-3d">🗄️</span><span class="mx-3 font-medium">مكتبة المستندات</span>
                    </a>
                    <a href="#" class="nav-link flex items-center px-4 py-3 mt-2 text-gray-300 hover:bg-gray-700 hover:text-white" data-page="notifications-log">
                        <span class="text-xl icon-3d">🔔</span><span class="mx-3 font-medium">اشعارات</span>
                    </a>
                </nav>
            </aside>
           
            <!-- Main Content -->
            <div class="flex-1 flex flex-col overflow-hidden">
                <!-- Header -->
                <header class="flex justify-between items-center p-4 bg-white border-b shadow-sm z-20">
                    <div class="flex items-center">
                         <button id="menu-toggle-button" class="md:hidden text-gray-600 focus:outline-none">
                             <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
                         </button>
                        <h1 class="text-xl font-semibold text-gray-800 mx-4" id="page-title">الرئيسية</h1>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div class="relative">
                            <button id="notification-bell" class="relative text-gray-600 hover:text-gray-800">
                                <span class="text-2xl icon-3d">🔔</span>
                                <span id="notification-indicator" class="hidden absolute top-0 right-0 h-2.5 w-2.5 bg-red-500 rounded-full border-2 border-white"></span>
                            </button>
                            <div id="notifications-dropdown" class="hidden absolute left-0 mt-2 w-80 bg-white rounded-lg shadow-xl overflow-hidden z-20">
                                <div class="py-2 px-4 font-bold border-b">الإشعارات</div>
                                <div id="notifications-list" class="max-h-64 overflow-y-auto"></div>
                            </div>
                        </div>
                        <div class="avatar-3d w-10 h-10 rounded-full bg-[#B8860B] flex items-center justify-center font-bold text-white border-2 border-white">ع</div>
                    </div>
                </header>
               
                <!-- Page Content -->
                <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-100 p-4 md:p-8">
                    <!-- Home Page (Content restored) -->
                    <div id="home" class="page-content">
                        <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6">
                            <div class="xl:col-span-1 bg-white p-6 rounded-xl shadow-lg flex flex-col items-center text-center">
                                <div class="w-24 h-24 rounded-full bg-yellow-100 flex items-center justify-center mb-4 border-4 border-white shadow-md">
                                    <span class="text-5xl" style="color: var(--gold-accent);">👤</span>
                                </div>
                                <h3 id="home-user-name" class="font-bold text-xl portal-theme-text"></h3>
                                <p id="home-user-role" class="text-sm text-gray-500"></p>
                            </div>
                            <a href="#" data-page="dashboard" class="nav-link-card bg-white p-6 rounded-xl shadow-lg hover:shadow-xl flex items-center gap-4">
                                <span class="text-4xl icon-3d">🎛️</span>
                                <div>
                                    <h3 class="font-bold text-xl portal-theme-text">لوحة التحكم</h3>
                                    <p class="text-sm text-gray-500">عرض المؤشرات والرسوم البيانية</p>
                                </div>
                            </a>
                             <a href="#" data-page="projects-sub" class="nav-link-card bg-white p-6 rounded-xl shadow-lg hover:shadow-xl flex items-center gap-4">
                                <span class="text-4xl icon-3d">🏗️</span>
                                <div>
                                    <h3 class="font-bold text-xl portal-theme-text">ادارة المشاريع</h3>
                                    <p class="text-sm text-gray-500">تصفح وتصنيف المشاريع والمستندات</p>
                                </div>
                            </a>
                             <a href="#" data-page="archive" class="nav-link-card bg-white p-6 rounded-xl shadow-lg hover:shadow-xl flex items-center gap-4">
                                <span class="text-4xl icon-3d">🗄️</span>
                                <div>
                                    <h3 class="font-bold text-xl portal-theme-text">مكتبة المستندات</h3>
                                    <p class="text-sm text-gray-500">الأرشيف الدائم لجميع الملفات</p>
                                </div>
                            </a>
                        </div>
                    </div>

                    <!-- Dashboard Page (Content and structure restored) -->
                    <div id="dashboard" class="page-content hidden">
                         <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                            <div class="bg-white p-5 rounded-xl shadow-lg text-center"><p class="text-4xl font-bold" style="color: var(--olive-dark);" id="kpi-total"></p><p class="text-gray-500 mt-1">إجمالي المشاريع</p></div>
                            <div class="bg-white p-5 rounded-xl shadow-lg text-center"><p class="text-4xl font-bold" style="color: var(--gold-accent);" id="kpi-ongoing"></p><p class="text-gray-500 mt-1">جاري طرحها</p></div>
                            <div class="bg-white p-5 rounded-xl shadow-lg text-center"><p class="text-4xl font-bold text-gray-500" id="kpi-previous"></p><p class="text-gray-500 mt-1">سابقة</p></div>
                            <div class="bg-white p-5 rounded-xl shadow-lg text-center"><p class="text-4xl font-bold text-blue-600" id="kpi-proposed"></p><p class="text-gray-500 mt-1">مقترحة</p></div>
                         </div>
                         <div class="grid grid-cols-1 lg:grid-cols-5 gap-6">
                            <div class="lg:col-span-3 bg-white p-6 rounded-xl shadow-lg"><h3 class="font-bold text-lg" style="color: var(--olive-dark);">توزيع المشاريع حسب المنطقة</h3><div class="chart-container"><canvas id="barChart"></canvas></div></div>
                            <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-lg flex flex-col">
                                <h3 class="font-bold text-lg mb-4" style="color: var(--olive-dark);">نسبة الإنجاز في المشاريع الجاري طرحها</h3>
                                <div id="average-completion-container" class="flex-grow flex items-center justify-center">
                                    <!-- SVG for circular progress bar will go here -->
                                </div>
                                <div id="ongoing-projects-completion-details" class="mt-4 flex-1 space-y-3 overflow-y-auto">
                                    <!-- Project details will be injected here -->
                                </div>
                            </div>
                         </div>
                    </div>

                    <!-- Projects Page -->
                    <div id="projects-sub" class="page-content hidden">
                       <div id="project-summary-cards" class="grid grid-cols-1 md:grid-cols-3 gap-6"></div>
                       <div id="filtered-project-view" class="hidden">
                             <div class="flex justify-between items-center mb-6">
                                <div class="flex items-center gap-4">
                                     <h2 id="filtered-project-title" class="text-2xl font-bold" style="color: var(--olive-dark);"></h2>
                                </div>
                                <div class="flex items-center gap-2">
                                     <button id="add-category-button" class="bg-blue-600 text-white text-sm rounded-lg px-4 py-2 hover:bg-blue-700 transition-colors flex items-center gap-2"><span>+</span> إضافة فئة</button>
                                     <button id="add-project-button" class="bg-green-600 text-white text-sm rounded-lg px-4 py-2 hover:bg-green-700 transition-colors flex items-center gap-2"><span>+</span> إضافة مشروع</button>
                                     <button id="back-to-summary" class="bg-gray-800 text-white text-sm rounded-lg px-4 py-2 hover:bg-black transition-colors">→ الرجوع</button>
                                </div>
                            </div>
                           
                           <div class="bg-white p-4 rounded-xl shadow-lg mb-6 grid grid-cols-1 md:grid-cols-2 gap-4">
                               <div>
                                   <label for="detail-region-filter" class="block text-sm font-medium text-gray-700">تصفية حسب المنطقة</label>
                                   <div class="flex items-center gap-2">
                                       <select id="detail-region-filter" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-yellow-500 focus:border-yellow-500 sm:text-sm rounded-md"></select>
                                       <button id="add-region-button" class="bg-blue-500 text-white rounded-full w-8 h-8 flex-shrink-0 flex items-center justify-center text-lg font-bold hover:bg-blue-600 transition-colors mt-1" title="إضافة منطقة جديدة">+</button>
                                   </div>
                               </div>
                               <div>
                                   <label for="details-search-filter" class="block text-sm font-medium text-gray-700">بحث شامل (اضغط Enter للبحث)</label>
                                   <input type="text" id="details-search-filter" placeholder="اكتب اسم مشروع أو ملف..." class="mt-1 focus:ring-yellow-500 focus:border-yellow-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md">
                               </div>
                           </div>
                           <div id="project-details-container" class="mt-6 space-y-4"></div>
                       </div>
                       <div id="document-list-view" class="hidden">
                            <div class="flex justify-between items-center mb-6">
                                <h2 id="document-list-title" class="text-2xl font-bold portal-theme-text"></h2>
                                <button id="back-to-project-details" class="bg-gray-800 text-white text-sm rounded-lg px-4 py-2 hover:bg-black transition-colors">→ الرجوع للمشاريع</button>
                            </div>
                            <div id="document-list-container" class="bg-white p-4 sm:p-6 rounded-xl shadow-lg"></div>
                       </div>
                    </div>

                    <!-- Tendering Page -->
                    <div id="tendering-sub" class="page-content hidden">
                        <div id="tendering-cards-view">
                            <h2 class="text-2xl font-bold mb-6" style="color: var(--olive-dark);">أدوات طرح المشاريع</h2>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                <div id="show-karrasa-page" class="functional-card cursor-pointer bg-white p-6 rounded-xl shadow-lg flex flex-col items-center text-center">
                                    <div class="w-20 h-20 rounded-full bg-indigo-100 flex items-center justify-center mb-4"><span class="text-4xl">📑</span></div>
                                    <h3 class="font-bold text-xl portal-theme-text">كراسات الشروط</h3>
                                    <p class="text-sm text-gray-500 mt-2">إنشاء وتعديل كراسات الشروط كنماذج.</p>
                                </div>
                                <div id="show-boq-items-page" class="functional-card cursor-pointer bg-white p-6 rounded-xl shadow-lg flex flex-col items-center text-center">
                                    <div class="w-20 h-20 rounded-full bg-blue-100 flex items-center justify-center mb-4"><span class="text-4xl">📝</span></div>
                                    <h3 class="font-bold text-xl portal-theme-text">بنود جدول الكميات</h3>
                                    <p class="text-sm text-gray-500 mt-2">إدارة البنود الفردية المستخدمة في جداول الكميات.</p>
                                </div>
                                <div id="show-boq-templates-page" class="functional-card cursor-pointer bg-white p-6 rounded-xl shadow-lg flex flex-col items-center text-center">
                                    <div class="w-20 h-20 rounded-full bg-green-100 flex items-center justify-center mb-4"><span class="text-4xl">📋</span></div>
                                    <h3 class="font-bold text-xl portal-theme-text">قوالب جدول الكميات</h3>
                                    <p class="text-sm text-gray-500 mt-2">إنشاء وتعديل قوالب جداول الكميات الجاهزة للمشاريع.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Karrasa Page -->
                    <div id="karrasa-page" class="page-content hidden">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold" style="color: var(--olive-dark);">إدارة كراسات الشروط</h2>
                            <button class="back-to-tendering-cards bg-gray-800 text-white text-sm rounded-lg px-4 py-2 hover:bg-black transition-colors">→ الرجوع</button>
                        </div>
                        <div id="karrasa-list-view">
                           <div class="bg-white p-6 rounded-xl shadow-lg">
                               <div class="flex items-center gap-4 mb-4">
                                   <button id="add-new-karrasa-btn" class="bg-blue-600 text-white text-sm rounded-lg px-4 py-2 hover:bg-blue-700"><span>➕</span> إضافة كراسة جديدة</button>
                               </div>
                               <div id="karrasa-list" class="space-y-3">
                                   <!-- Karrasa items will be listed here -->
                               </div>
                           </div>
                        </div>
                        <div id="karrasa-editor-view" class="hidden bg-white p-6 rounded-xl shadow-lg">
                            <div>
                                <label for="karrasaName" class="block text-sm font-medium mb-1">اسم الكراسة</label>
                                <input type="text" id="karrasaName" placeholder="مثال: كراسة شروط مشروع صيانة" class="data-table input w-full mb-4">
                            </div>
                            <div>
                                <label for="karrasaContent" class="block text-sm font-medium mb-1">المحتوى</label>
                                <textarea id="karrasaContent" rows="15" class="data-table textarea w-full"></textarea>
                            </div>
                            <div class="mt-4 flex justify-between items-center">
                                <div>
                                    <button id="karrasa-import-word" class="bg-teal-600 text-white text-sm rounded-lg px-4 py-2 hover:bg-teal-700 flex items-center gap-2"><span>📤</span> استيراد من Word</button>
                                    <button id="karrasa-export-word" class="bg-green-600 text-white text-sm rounded-lg px-4 py-2 hover:bg-green-700 flex items-center gap-2"><span>⬇️</span> تحميل كـ Word</button>
                                </div>
                                <div>
                                    <button id="cancel-karrasa-edit" class="bg-gray-500 text-white text-sm rounded-lg px-4 py-2 hover:bg-gray-600">إلغاء</button>
                                    <button id="save-karrasa-edit" class="bg-blue-600 text-white text-sm rounded-lg px-4 py-2 hover:bg-blue-700 mr-2">حفظ الكراسة</button>
                                </div>
                            </div>
                        </div>
                    </div>


                    <!-- BOQ Items Page -->
                    <div id="boq-items-page" class="page-content hidden">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold" style="color: var(--olive-dark);">بنود جدول الكميات</h2>
                            <button class="back-to-tendering-cards bg-gray-800 text-white text-sm rounded-lg px-4 py-2 hover:bg-black transition-colors">→ الرجوع</button>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-lg">
                            <div class="flex items-center gap-4 mb-4">
                                <button id="add-boq-item-btn" class="bg-blue-600 text-white text-sm rounded-lg px-4 py-2 hover:bg-blue-700"><span>➕</span> إضافة بند</button>
                                <button id="boq-import-excel" class="bg-teal-600 text-white text-sm rounded-lg px-4 py-2 hover:bg-teal-700 flex items-center gap-2"><span>📤</span> استيراد من Excel</button>
                                <button id="boq-export-all" class="bg-green-600 text-white text-sm rounded-lg px-4 py-2 hover:bg-green-700 flex items-center gap-2"><span>⬇️</span> تحميل الكل (Excel)</button>
                                <button id="boq-export-selected" disabled class="bg-yellow-500 text-white text-sm rounded-lg px-4 py-2 hover:bg-yellow-600 flex items-center gap-2"><span>⬇️</span> تحميل المحدد (Excel)</button>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="min-w-full data-table">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="w-12"><input type="checkbox" id="boq-select-all-checkbox"></th>
                                            <th>رقم البند</th><th>اسم البند</th><th>وحدة القياس</th><th>السعر</th><th>بيان الأعمال</th><th>الفئة</th><th>التخصص</th><th>إجراءات</th>
                                        </tr>
                                    </thead>
                                    <tbody id="boq-items-table-body"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <input type="file" id="excel-file-input" class="hidden" accept=".xlsx, .xls">
                    <input type="file" id="word-file-input" class="hidden" accept=".docx">
                    <input type="file" id="excel-template-file-input" class="hidden" accept=".xlsx, .xls">


                    <!-- BOQ Templates Page (Container for new design) -->
                    <div id="boq-templates-page" class="page-content hidden">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold" style="color: var(--olive-dark);">قوالب جدول الكميات</h2>
                             <div id="boq-editor-top-buttons" class="hidden">
                                <button class="back-to-boq-templates-list bg-gray-800 text-white text-sm rounded-lg px-4 py-2 hover:bg-black">→ الرجوع للقوالب</button>
                             </div>
                        </div>

                        <!-- View for Listing Templates -->
                        <div id="boq-templates-list-view">
                           <div class="bg-white p-6 rounded-xl shadow-lg">
                               <div class="flex items-center gap-4 mb-4">
                                   <button id="show-boq-template-editor-btn" data-template-id="new" class="bg-blue-600 text-white text-sm rounded-lg px-4 py-2 hover:bg-blue-700"><span>➕</span> إضافة جدول جديد</button>
                               </div>
                               <div id="boq-templates-list" class="space-y-3">
                                   <p class="text-gray-500">لا توجد قوالب محفوظة.</p>
                               </div>
                           </div>
                        </div>
                        
                        <!-- NEW: BOQ Template Editor View (Redesigned) -->
                        <div id="boq-template-editor-view" class="hidden bg-white p-6 rounded-xl shadow-lg">
                             <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 border-b pb-4">
                                 <div>
                                     <label for="boqTemplateName" class="block text-sm font-medium">اسم الجدول</label>
                                     <input type="text" id="boqTemplateName" placeholder="مثال: جدول كميات مبنى رئيسي" class="mt-1 block w-full data-table input">
                                 </div>
                                 <div>
                                     <label for="boqTemplateCategory" class="block text-sm font-medium">الفئة</label>
                                     <select id="boqTemplateCategory" class="mt-1 block w-full data-table select"></select>
                                 </div>
                                 <div>
                                     <label for="boqTemplateSpecialization" class="block text-sm font-medium">التخصص</label>
                                     <select id="boqTemplateSpecialization" class="mt-1 block w-full data-table select"></select>
                                 </div>
                            </div>
                             <div class="flex justify-between items-center mb-4 flex-wrap gap-4">
                                <div id="boq-editor-actions" class="flex items-center gap-2 flex-wrap">
                                    <button id="addBoqTemplateRow" class="bg-blue-500 text-white text-sm rounded-md px-3 py-1.5 hover:bg-blue-600 flex items-center gap-1">➕ <span>إضافة بند</span></button>
                                    <button id="boq-template-import-excel" class="bg-teal-600 text-white text-sm rounded-md px-3 py-1.5 hover:bg-teal-700 flex items-center gap-2"><span>📤</span> استيراد</button>
                                    <button id="boq-template-export-all" class="bg-green-600 text-white text-sm rounded-md px-3 py-1.5 hover:bg-green-700 flex items-center gap-2"><span>⬇️</span> تحميل الكل</button>
                                    <button id="boq-template-export-selected" disabled class="bg-yellow-500 text-white text-sm rounded-md px-3 py-1.5 hover:bg-yellow-600 flex items-center gap-2"><span>⬇️</span> تحميل المحدد</button>
                                </div>
                                <div class="relative">
                                    <input type="text" id="boqSearch" placeholder="بحث..." class="data-table input pr-8">
                                    <span class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-400">🔍</span>
                                </div>
                             </div>

                             <div class="overflow-x-auto">
                                <table id="boq-template-table" class="min-w-full text-sm boq-template-table data-table">
                                     <thead class="bg-gray-200">
                                         <tr>
                                            <th class="p-2"><input type="checkbox" id="boq-template-select-all"></th>
                                            <th>كود البند</th>
                                            <th>رقم البند</th>
                                            <th>بيان الأعمال</th>
                                            <th>فئة البند</th>
                                            <th>الوحدة</th>
                                            <th>الكمية</th>
                                            <th>السعر الإفرادي (رقماً)</th>
                                            <th>السعر الإفرادي (كتابة)</th>
                                            <th>السعر الإجمالي (رقماً)</th>
                                            <th>السعر الإجمالي (كتابة)</th>
                                            <th>إجراء</th>
                                         </tr>
                                     </thead>
                                     <tbody>
                                        <!-- Rows will be dynamically inserted here -->
                                     </tbody>
                                     <tfoot class="bg-gray-200 font-bold">
                                         <tr>
                                             <td colspan="10" class="p-3 text-left">الإجمالي الكلي للأعمال (فقط لا غير)</td>
                                             <td id="boq-grand-total" class="p-3 text-center" colspan="2">0.00 ريال</td>
                                         </tr>
                                     </tfoot>
                                 </table>
                             </div>
                             <div class="flex justify-between items-center mt-4">
                                 <div class="text-sm text-gray-600">
                                     <span>عدد البنود:</span>
                                     <span id="boq-item-count">0</span>
                                 </div>
                                 <div id="boq-pagination" class="flex items-center gap-2 text-sm">
                                     <button id="boq-prev-page" class="px-2 py-1 rounded bg-gray-300 hover:bg-gray-400 disabled:opacity-50">السابق</button>
                                     <span>صفحة <span id="boq-current-page">1</span> من <span id="boq-total-pages">1</span></span>
                                     <button id="boq-next-page" class="px-2 py-1 rounded bg-gray-300 hover:bg-gray-400 disabled:opacity-50">التالي</button>
                                 </div>
                                 <div id="boq-editor-save-actions">
                                    <button id="cancel-boq-template" class="bg-gray-500 text-white text-sm rounded-lg px-4 py-2 hover:bg-gray-600">إلغاء</button>
                                    <button id="save-boq-template" class="bg-green-600 text-white text-sm rounded-lg px-4 py-2 hover:bg-green-700 mr-2">حفظ الجدول</button>
                                 </div>
                             </div>
                        </div>
                    </div>
                    
                    <div id="studies-sub" class="page-content hidden"></div>
                    <div id="engineering-supervision" class="page-content hidden"></div>
                    <div id="entities" class="page-content hidden"></div>
                    
                    <!-- Archive Page -->
                    <div id="archive" class="page-content hidden">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold" style="color: var(--olive-dark);">مكتبة المستندات</h2>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-lg">
                            <div class="flex items-center gap-4 mb-4">
                                <input type="text" id="archive-search" placeholder="بحث عن ملف، مشروع، مستخدم..." class="data-table input w-full md:w-1/3">
                            </div>
                            <div class="overflow-x-auto">
                                <table class="min-w-full data-table">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th>اسم الملف</th>
                                            <th>اسم المشروع</th>
                                            <th>حالة المشروع</th>
                                            <th>المستخدم</th>
                                            <th>تاريخ الإضافة</th>
                                            <th>الإجراء</th>
                                        </tr>
                                    </thead>
                                    <tbody id="archive-table-body">
                                        <!-- Rows will be injected here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Notifications Log Page -->
                     <div id="notifications-log" class="page-content hidden">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold" style="color: var(--olive-dark);">سجل التعديلات (الإشعارات)</h2>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-lg">
                            <div class="flex items-center gap-4 mb-4">
                                <input type="text" id="notifications-search" placeholder="بحث في السجل..." class="data-table input w-full md:w-1/3">
                            </div>
                            <div class="overflow-x-auto">
                                <table class="min-w-full data-table">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th>التاريخ</th>
                                            <th>القسم</th>
                                            <th>العنصر</th>
                                            <th>الإجراء</th>
                                            <th>المستخدم</th>
                                            <th>التفاصيل</th>
                                        </tr>
                                    </thead>
                                    <tbody id="notifications-log-table-body">
                                        <!-- Log rows will be injected here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>


                </main>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="documentViewModal" class="fixed inset-0 bg-black bg-opacity-60 z-50 hidden items-center justify-center p-4 modal-backdrop">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col modal-content">
             <div class="p-4 border-b flex justify-between items-center"><h3 id="document-view-title" class="text-xl font-bold portal-theme-text"></h3><button class="close-modal text-gray-400">&times;</button></div>
             <div class="p-6 flex-1 overflow-y-auto" id="document-viewer-content"></div>
             <div class="p-4 bg-gray-50 border-t flex justify-end"><button id="downloadDocumentBtn" class="bg-gray-800 text-white text-sm rounded-lg px-4 py-2 hover:bg-black">تحميل</button></div>
        </div>
    </div>
    <div id="addProjectModal" class="fixed inset-0 bg-black bg-opacity-60 z-50 hidden items-center justify-center p-4 modal-backdrop">
        <form id="addProjectForm" class="bg-white rounded-2xl shadow-2xl w-full max-w-xl modal-content">
            <div class="p-4 border-b flex justify-between items-center">
                <h3 class="text-xl font-bold portal-theme-text">إضافة مشروع جديد</h3>
                <button type="button" class="close-modal text-gray-400">&times;</button>
            </div>
            <div class="p-6">
                <div id="add-project-step-1"><h4 class="font-semibold text-lg mb-4">الخطوة 1: اختر نوع المشروع</h4><div id="add-project-type-container" class="grid grid-cols-1 md:grid-cols-3 gap-4"></div></div>
                <div id="add-project-step-2" class="hidden"><h4 class="font-semibold text-lg mb-4">الخطوة 2: اختر المنطقة</h4><div id="add-project-region-container" class="grid grid-cols-1 md:grid-cols-3 gap-4"></div></div>
                <div id="add-project-step-3" class="hidden"><h4 class="font-semibold text-lg mb-4">الخطوة 3: أدخل اسم المشروع</h4><div><label for="newProjectName" class="block text-sm font-medium">اسم المشروع</label><input type="text" id="newProjectName" required class="mt-1 data-table input"></div></div>
            </div>
            <div class="p-4 bg-gray-50 border-t flex justify-end space-x-2 space-x-reverse">
                <button type="button" id="backAddProjectStep" class="bg-gray-200 text-gray-700 text-sm rounded-lg px-4 py-2 hover:bg-gray-300 hidden">السابق</button>
                <button type="submit" id="submitAddProject" class="text-white text-sm rounded-lg px-4 py-2 hidden" style="background-color: var(--olive-dark);">إنشاء</button>
            </div>
        </form>
    </div>
     <!-- Add Category Modal -->
    <div id="addCategoryModal" class="fixed inset-0 bg-black bg-opacity-60 z-50 hidden items-center justify-center p-4 modal-backdrop">
        <form id="addCategoryForm" class="bg-white rounded-2xl shadow-2xl w-full max-w-md modal-content">
            <div class="p-4 border-b flex justify-between items-center">
                <h3 class="text-xl font-bold portal-theme-text">إضافة فئة مشروع جديدة</h3>
                <button type="button" class="close-modal text-gray-400 hover:text-gray-800 text-3xl leading-none">&times;</button>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label for="newCategoryName" class="block text-sm font-medium text-gray-700">اسم الفئة الجديدة</label>
                    <input type="text" id="newCategoryName" required placeholder="مثال: أعمال صيانة" class="mt-1 data-table input">
                </div>
                <div>
                    <label for="newCategoryIcon" class="block text-sm font-medium text-gray-700">الرمز التعبيري للفئة</label>
                    <input type="text" id="newCategoryIcon" required placeholder="مثال: 🔧" class="mt-1 data-table input">
                </div>
            </div>
            <div class="p-4 bg-gray-50 border-t flex justify-end">
                <button type="submit" class="text-white text-sm rounded-lg px-4 py-2 transition-colors" style="background-color: var(--olive-dark);">إضافة الفئة</button>
            </div>
        </form>
    </div>
    <!-- Add Region Modal -->
    <div id="addRegionModal" class="fixed inset-0 bg-black bg-opacity-60 z-50 hidden items-center justify-center p-4 modal-backdrop">
        <form id="addRegionForm" class="bg-white rounded-2xl shadow-2xl w-full max-w-md modal-content">
            <div class="p-4 border-b flex justify-between items-center">
                <h3 class="text-xl font-bold portal-theme-text">إضافة منطقة جديدة</h3>
                <button type="button" class="close-modal text-gray-400 hover:text-gray-800 text-3xl leading-none">&times;</button>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label for="newRegionName" class="block text-sm font-medium text-gray-700">اسم المنطقة الجديدة</label>
                    <input type="text" id="newRegionName" required placeholder="مثال: المنطقة الشمالية" class="mt-1 data-table input">
                </div>
            </div>
            <div class="p-4 bg-gray-50 border-t flex justify-end">
                <button type="submit" class="text-white text-sm rounded-lg px-4 py-2 transition-colors" style="background-color: var(--olive-dark);">إضافة المنطقة</button>
            </div>
        </form>
    </div>
    <!-- Add File Modal (Updated) -->
    <div id="addFileModal" class="fixed inset-0 bg-black bg-opacity-60 z-50 hidden items-center justify-center p-4 modal-backdrop">
        <form id="addFileForm" class="bg-white rounded-2xl shadow-2xl w-full max-w-lg modal-content">
             <div class="p-4 border-b flex justify-between items-center">
                <h3 id="addFileModalTitle" class="text-xl font-bold portal-theme-text">إرفاق ملفات</h3>
                <button type="button" class="close-modal text-gray-400">&times;</button>
            </div>
             <div class="p-6 space-y-4">
                 <div>
                    <label for="attachFileInput" class="block text-sm font-medium text-gray-700 mb-2">اختر ملف أو عدة ملفات</label>
                    <input type="file" id="attachFileInput" multiple class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-yellow-50 file:text-yellow-700 hover:file:bg-yellow-100"/>
                 </div>
                 <div id="file-preview-list" class="mt-4 space-y-2 max-h-40 overflow-y-auto"></div>
             </div>
             <div class="p-4 bg-gray-50 border-t flex justify-end space-x-2 space-x-reverse">
                <button type="button" class="close-modal bg-gray-200 text-gray-700 rounded-lg px-4 py-2 hover:bg-gray-300">إلغاء</button>
                <button type="submit" class="text-white rounded-lg px-4 py-2" style="background-color: var(--olive-dark);">إضافة الملفات المحددة</button>
            </div>
        </form>
    </div>
    <div id="addBoqItemModal" class="fixed inset-0 bg-black bg-opacity-60 z-50 hidden items-center justify-center p-4 modal-backdrop">
        <form id="addBoqItemForm" class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl modal-content">
            <div class="p-4 border-b flex justify-between items-center">
                <h3 id="boqItemModalTitle" class="text-xl font-bold portal-theme-text">إضافة بند جديد</h3>
                <button type="button" class="close-modal text-gray-400">&times;</button>
            </div>
            <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-4">
                <input type="hidden" id="boqItemId">
                <div><label for="boqItemNumber" class="block text-sm font-medium">رقم البند</label><input type="text" id="boqItemNumber" required class="mt-1 data-table input"></div>
                <div><label for="boqItemName" class="block text-sm font-medium">اسم البند</label><input type="text" id="boqItemName" required class="mt-1 data-table input"></div>
                <div><label for="boqItemUnit" class="block text-sm font-medium">الوحدة</label><input type="text" id="boqItemUnit" required class="mt-1 data-table input"></div>
                <div><label for="boqItemPrice" class="block text-sm font-medium">السعر</label><input type="number" step="0.01" id="boqItemPrice" required class="mt-1 data-table input"></div>
                <div class="md:col-span-2"><label for="boqItemScope" class="block text-sm font-medium">بيان الأعمال</label><textarea id="boqItemScope" rows="3" class="mt-1 data-table textarea"></textarea></div>
                <div><label for="boqItemCategory" class="block text-sm font-medium">الفئة</label><select id="boqItemCategory" required class="mt-1 data-table select"></select></div>
                <div><label for="boqItemSpecialization" class="block text-sm font-medium">التخصص</label><select id="boqItemSpecialization" required class="mt-1 data-table select"></select></div>
            </div>
            <div class="p-4 bg-gray-50 border-t flex justify-end"><button type="submit" class="text-white rounded-lg px-4 py-2" style="background-color: var(--olive-dark);">حفظ</button></div>
        </form>
    </div>
    <!-- Confirmation Modal -->
    <div id="confirmationModal" class="fixed inset-0 bg-black bg-opacity-60 z-50 hidden items-center justify-center p-4 modal-backdrop">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md modal-content">
            <div class="p-6 text-center">
                <div class="w-16 h-16 rounded-full bg-red-100 mx-auto flex items-center justify-center text-3xl">⚠️</div>
                <h3 id="confirmationModalTitle" class="text-xl font-bold mt-5">هل أنت متأكد؟</h3>
                <p id="confirmationModalText" class="text-gray-500 text-sm my-2">لا يمكن التراجع عن هذا الإجراء.</p>
            </div>
            <div class="p-4 bg-gray-50 border-t flex justify-center space-x-2 space-x-reverse">
                <button id="confirmDeleteBtn" class="bg-red-600 text-white text-sm rounded-lg px-4 py-2 hover:bg-red-700 transition-colors">تأكيد الحذف</button>
                <button id="cancelDeleteBtn" class="bg-gray-200 text-gray-700 text-sm rounded-lg px-4 py-2 hover:bg-gray-300 transition-colors">إلغاء</button>
            </div>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const loginPage = document.getElementById('login-page');
            const portalPage = document.getElementById('portal-page');
            const loginForm = document.getElementById('login-form');
            loginForm?.addEventListener('submit', e => {
                e.preventDefault();
                loginPage?.classList.add('hidden');
                portalPage?.classList.remove('hidden');
                initializePortal();
            });
            
            function initializePortal() {
                // --- DATA ---
                const currentUser = { name: 'مدير النظام', role: 'مسؤول أول' };
                let activityLog = [];
                let projects = [
                    { id: 1, name: 'تطوير الواجهة البحرية', type: 'انشاءات', region: 'مكة', status: 'المشاريع المقترحة', docs: [101, 102], completion: 10 },
                    { id: 2, name: 'بناء مجمع سكني', type: 'انشاءات', region: 'الرياض', status: 'المشاريع السابقة', docs: [201], completion: 100 },
                    { id: 3, name: 'ترميم مبنى تاريخي', type: 'ترميمات', region: 'المدينة', status: 'المشاريع السابقة', docs: [301], completion: 100 },
                    { id: 4, name: 'توريد أجهزة حاسب', type: 'توريدات', region: 'الرياض', status: 'المشاريع المقترحة', docs: [], completion: 5 },
                    { id: 5, name: 'إنشاء حديقة عامة', type: 'انشاءات', region: 'الرياض', status: 'المشاريع الجاري طرحها', docs: [501], completion: 75 },
                    { id: 6, name: 'توريد أثاث مكتبي', type: 'توريدات', region: 'مكة', status: 'المشاريع الجاري طرحها', docs: [], completion: 40 }
                ];
                let documentArchive = [
                    {id: 101, projectId: 1, type: 'karrasa', name:'كراسة شروط الواجهة.txt', fileType: 'text/plain', content: 'data:text/plain;base64,2KfYsdisINiv2YjYsdmK2Kkg2KfZhNi52YLYqNmK2Kkg2YTZhNi52YLYqNin2KzZitip', addedBy: 'النظام', addedDate: new Date('2023-01-15')},
                    {id: 102, projectId: 1, type: 'mokhatat', name:'مخطط الواجهة.pdf', fileType: 'application/pdf', content: null, addedBy: 'النظام', addedDate: new Date('2023-01-16')},
                    {id: 201, projectId: 2, type: 'jadwal', name:'جدول كميات المجمع.json', fileType: 'application/json', content: 'data:application/json;base64,eyAiaXRlbSI6ICJleGFtcGxlIiwgInF1YW50aXR5IjogMTAwIH0=', addedBy: 'النظام', addedDate: new Date('2023-02-20')},
                    {id: 301, projectId: 3, type: 'mokhatat', name:'مخطط ترميم المبنى.pdf', fileType: 'application/pdf', content: null, addedBy: 'النظام', addedDate: new Date('2023-03-10')},
                    {id: 501, projectId: 5, type: 'karrasa', name:'كراسة شروط الحديقة.pdf', fileType: 'application/pdf', content: null, addedBy: 'النظام', addedDate: new Date('2023-05-05')},
                ];
                let boqItems = [
                    { id: 1, number: '101', name: 'أعمال حفر', unit: 'م3', price: 75, scope: 'حفر وترحيل', category: 'إنشائي', specialization: 'مدني' },
                    { id: 2, number: '205', name: 'أبواب خشب', unit: 'عدد', price: 1200, scope: 'باب خشب سويدي', category: 'معماري', specialization: 'تشطيبات' },
                ];
                let boqTemplates = [];
                let karrasaTemplates = [{id: 1, name: "كراسة شروط عامة", content: "محتوى تجريبي للكراسة..."}];
                let currentEditingKarrasaId = null;

                let availableRegions = ['الرياض', 'مكة', 'المدينة', 'الشرقية'];
                let availableCategories = ['إنشائي', 'معماري', 'كهرباء', 'ميكانيكا'];
                let availableSpecializations = ['مدني', 'تشطيبات', 'قوى', 'تكييف'];
                let projTypeMeta = {'انشاءات': { name: 'الانشاءات', icon: '🏗️' },'ترميمات': { name: 'الترميمات', icon: '🛠️' },'توريدات': { name: 'التوريدات', icon: '📦' }};
                const docTypeMeta = {'karrasa': { name: 'كراسات الشروط', icon: '📄' },'mokhatat': { name: 'المخططات', icon: '🗺️' },'jadwal': { name: 'جدول الكميات', icon: '📋' },'wathiqa': { name: 'وثائق الزامية', icon: '📎' }};
                
                // --- STATE & SELECTORS ---
                const pages = document.querySelectorAll('.page-content');
                const pageTitle = document.getElementById('page-title');
                const sidebar = document.getElementById('sidebar');
                let currentProjectStatus = '', currentRegion = 'all', newProjectData = {}, currentAddFileContext = {};
                const boqItemsPage = document.getElementById('boq-items-page');
                const karrasaPage = document.getElementById('karrasa-page');
                const boqTemplatesPage = document.getElementById('boq-templates-page');
                const tenderingCardsView = document.getElementById('tendering-cards-view');
                let barChart; 
                
                // BOQ Template Editor State
                let currentBoqTemplateData = [];
                let currentBoqTemplatePage = 1;
                const BOQ_ROWS_PER_PAGE = 6;
                let currentEditingTemplateId = null;

                // Notification elements and synth
                const notificationBell = document.getElementById('notification-bell');
                const notificationIndicator = document.getElementById('notification-indicator');
                const notificationsDropdown = document.getElementById('notifications-dropdown');
                const notificationsList = document.getElementById('notifications-list');
                const synth = new Tone.Synth({
                    oscillator: { type: 'sine' },
                    envelope: { attack: 0.005, decay: 0.1, sustain: 0.3, release: 0.2 }
                }).toDestination();


                // --- UTILITY FUNCTIONS ---
                function logActivity(section, item, action, details) {
                    const logEntry = {
                        date: new Date(),
                        section: section,
                        item: item,
                        action: action,
                        user: currentUser.name,
                        details: details
                    };
                    activityLog.unshift(logEntry); // unshift to add to the top
                    if (activityLog.length > 200) {
                        activityLog.pop();
                    }
                    triggerNotification(logEntry);
                }

                 function triggerNotification(log) {
                    if (!notificationBell || !notificationIndicator || !notificationsList) return;

                    // Play sound
                    synth.triggerAttackRelease("C5", "8n");

                    // Jiggle the bell
                    notificationBell.classList.add('jiggle');
                    setTimeout(() => notificationBell.classList.remove('jiggle'), 600);

                    // Show indicator
                    notificationIndicator.classList.remove('hidden');

                    // Update dropdown list
                    const listItem = document.createElement('a');
                    listItem.href = "#";
                    listItem.className = "block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100";
                    listItem.innerHTML = `<p class="font-bold">${log.section}: ${log.action}</p><p class="text-xs text-gray-500">${log.item}</p>`;
                    notificationsList.insertBefore(listItem, notificationsList.firstChild);

                    // Limit dropdown items
                    if (notificationsList.children.length > 5) {
                        notificationsList.removeChild(notificationsList.lastChild);
                    }
                }
                
                notificationBell.addEventListener('click', () => {
                    notificationsDropdown.classList.toggle('hidden');
                    notificationIndicator.classList.add('hidden');
                });

                document.addEventListener('click', (event) => {
                    if (!notificationBell.contains(event.target) && !notificationsDropdown.contains(event.target)) {
                        notificationsDropdown.classList.add('hidden');
                    }
                });

                function b64DecodeUnicode(str) { try { const binaryStr = atob(str); const len = binaryStr.length; const bytes = new Uint8Array(len); for (let i = 0; i < len; i++) { bytes[i] = binaryStr.charCodeAt(i); } return new TextDecoder().decode(bytes); } catch (e) { return "Error: Could not decode content."; } }

                // --- NAVIGATION ---
                function showPage(pageId) {
                    if (!pageId) return;

                    // Hide all main content pages
                    pages.forEach(page => {
                        if (page) page.classList.add('hidden');
                    });

                    // Show the target page
                    const targetPage = document.getElementById(pageId);
                    if (targetPage) {
                        targetPage.classList.remove('hidden');
                    } else {
                        console.error(`Page with id "${pageId}" not found. Showing home page.`);
                        const homePage = document.getElementById('home');
                        if (homePage) homePage.classList.remove('hidden');
                        return;
                    }
                    
                    // Run setup functions for specific pages
                    if (pageId === 'tendering-sub') {
                        const tenderingCardsView = document.getElementById('tendering-cards-view');
                        if (tenderingCardsView) tenderingCardsView.classList.remove('hidden');
                        karrasaPage.classList.add('hidden');
                        boqItemsPage.classList.add('hidden');
                        boqTemplatesPage.classList.add('hidden');
                    } else if (pageId === 'projects-sub') {
                        renderSummaryCards();
                    } else if (pageId === 'dashboard') {
                        renderDashboard();
                    } else if (pageId === 'boq-items-page' || pageId === 'boq-templates-page' || pageId === 'karrasa-page') {
                        document.getElementById('tendering-sub').classList.remove('hidden');
                        if (pageId === 'boq-items-page') renderBoqItemsTable();
                        else if (pageId === 'boq-templates-page') showBoqTemplatesListView();
                        else if (pageId === 'karrasa-page') showKarrasaListView();
                    } else if (pageId === 'archive') {
                        renderArchivePage();
                    } else if (pageId === 'notifications-log') {
                        renderNotificationsLogPage();
                    }


                    // Update nav links and title
                    document.querySelectorAll('.nav-link, .nav-parent-button').forEach(el => el.classList.remove('active'));
                    
                    const activeLink = Array.from(document.querySelectorAll('.nav-link')).find(link => link.dataset.page === pageId);
                    if (activeLink) {
                        activeLink.classList.add('active');
                        pageTitle.textContent = activeLink.textContent.trim();

                        // Activate parent dropdowns if any
                        const parentSubMenu = activeLink.closest('.submenu');
                        if (parentSubMenu) {
                             const studiesToggle = document.getElementById('studies-dropdown-toggle');
                             if(studiesToggle) studiesToggle.classList.add('active');
                        }
                        const parentMainMenu = activeLink.closest('#projects-dropdown-menu');
                        if(parentMainMenu) {
                             const projectsToggle = document.getElementById('projects-dropdown-toggle');
                             if(projectsToggle) projectsToggle.classList.add('active');
                        }
                    } else if (targetPage) {
                         pageTitle.textContent = targetPage.querySelector('h2')?.textContent.trim() || pageId;
                    }


                    if (window.innerWidth < 768) {
                        if(sidebar) sidebar.classList.add('translate-x-full');
                    }
                }

                document.querySelectorAll('.nav-link, .nav-link-card').forEach(link => link.addEventListener('click', e => { e.preventDefault(); showPage(link.dataset.page); }));
                document.getElementById('menu-toggle-button')?.addEventListener('click', () => sidebar?.classList.toggle('translate-x-full'));
                ['projects-dropdown-toggle', 'studies-dropdown-toggle'].forEach(id => {
                    document.getElementById(id)?.addEventListener('click', e => {
                        e.stopPropagation();
                        e.currentTarget.nextElementSibling?.classList.toggle('hidden');
                        e.currentTarget.querySelector('svg')?.classList.toggle('rotate-180');
                    });
                });

                // ===== DASHBOARD LOGIC (Unchanged) =====
                function renderDashboard() {
                    const kpiTotal = document.getElementById('kpi-total'), kpiOngoing = document.getElementById('kpi-ongoing'), kpiPrevious = document.getElementById('kpi-previous'), kpiProposed = document.getElementById('kpi-proposed');
                    const barChartCanvas = document.getElementById('barChart');
                    if(kpiTotal) kpiTotal.textContent = projects.length;
                    if(kpiOngoing) kpiOngoing.textContent = projects.filter(p => p.status === 'المشاريع الجاري طرحها').length;
                    if(kpiPrevious) kpiPrevious.textContent = projects.filter(p => p.status === 'المشاريع السابقة').length;
                    if(kpiProposed) kpiProposed.textContent = projects.filter(p => p.status === 'المشاريع المقترحة').length;
                    if(barChartCanvas){ const barCtx = barChartCanvas.getContext('2d'); const regionData = projects.reduce((acc, p) => ({ ...acc, [p.region]: (acc[p.region] || 0) + 1 }), {}); if (barChart) barChart.destroy(); barChart = new Chart(barCtx, { type: 'bar', data: { labels: Object.keys(regionData), datasets: [{ data: Object.values(regionData), backgroundColor: 'var(--olive-dark)' }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } } }); }
                }

                // ===== PROJECTS PAGE LOGIC (Unchanged) =====
                function renderSummaryCards() {
                    document.getElementById('filtered-project-view').classList.add('hidden');
                    document.getElementById('document-list-view').classList.add('hidden');
                    const container = document.getElementById('project-summary-cards');
                    container.classList.remove('hidden');
                    const statuses = { "المشاريع السابقة": { count: projects.filter(p => p.status === 'المشاريع السابقة').length, icon: '📜' }, "المشاريع الجاري طرحها": { count: projects.filter(p => p.status === 'المشاريع الجاري طرحها').length, icon: '⏳' }, "المشاريع المقترحة": { count: projects.filter(p => p.status === 'المشاريع المقترحة').length, icon: '💡' } };
                    container.innerHTML = Object.entries(statuses).map(([status, data]) => `<div class="summary-card cursor-pointer bg-white p-6 rounded-xl shadow-lg" data-status="${status}"><div class="flex items-center"><span class="text-3xl">${data.icon}</span><h3 class="font-bold text-xl mr-4">${status}</h3></div><p class="text-4xl font-bold mt-2">${data.count} <span class="text-lg">مشروع</span></p></div>`).join('');
                }
                document.getElementById('project-summary-cards')?.addEventListener('click', e => { const card = e.target.closest('.summary-card'); if(card) handleSummaryCardClick(card); });
                function handleSummaryCardClick(card) { currentProjectStatus = card.dataset.status; document.getElementById('project-summary-cards').classList.add('hidden'); document.getElementById('filtered-project-view').classList.remove('hidden'); document.getElementById('filtered-project-title').textContent = currentProjectStatus; renderRegionFilters('detail-region-filter'); renderProjectDetails(); }
                document.getElementById('back-to-summary')?.addEventListener('click', renderSummaryCards);
                document.getElementById('detail-region-filter')?.addEventListener('change', e => { currentRegion = e.target.value; renderProjectDetails(); });
                document.getElementById('details-search-filter')?.addEventListener('keydown', e => { if (e.key === 'Enter') renderProjectDetails(); });
                const projectHasMatchingDoc = (project, term) => project.docs.some(docId => documentArchive.find(d => d.id === docId)?.name.toLowerCase().includes(term));
                function renderProjectDetails() { const container = document.getElementById('project-details-container'); container.innerHTML = ''; const term = document.getElementById('details-search-filter').value.toLowerCase(); Object.keys(projTypeMeta).forEach(projTypeKey => { const meta = projTypeMeta[projTypeKey]; const filteredProjects = projects.filter(p => p.status === currentProjectStatus && p.type === projTypeKey && (currentRegion === 'all' || p.region === currentRegion) && (term === '' || p.name.toLowerCase().includes(term) || projectHasMatchingDoc(p, term))); const projectsHtml = filteredProjects.length > 0 ? filteredProjects.map(project => { const docsHtml = Object.keys(docTypeMeta).map(docTypeKey => `<div class="bg-gray-50 p-3 rounded-lg"><h5 class="font-semibold">${docTypeMeta[docTypeKey].icon} ${docTypeMeta[docTypeKey].name}</h5><div class="mt-2 flex justify-between items-center"><button class="view-doc-list-btn text-sm text-blue-600" data-project-id="${project.id}" data-doc-type="${docTypeKey}">عرض</button><button class="add-file-to-project-btn bg-green-100 text-green-700 rounded-full w-7 h-7 text-lg" data-project-id="${project.id}" data-doc-type="${docTypeKey}">+</button></div></div>`).join(''); return `<div class="project-accordion-item bg-white rounded-lg shadow-sm"><button class="project-accordion-toggle w-full p-4 flex justify-between items-center text-right font-semibold"><span>${project.name} (${project.region})</span><svg class="w-5 h-5 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg></button><div class="project-accordion-content hidden p-4 border-t grid grid-cols-2 lg:grid-cols-4 gap-3">${docsHtml}</div></div>`; }).join('') : `<div class="text-center text-gray-500 p-4 bg-gray-50 rounded-lg">لا توجد مشاريع في هذه الفئة.</div>`; container.innerHTML += `<div class="proj-type-accordion-item bg-white rounded-xl shadow-lg overflow-hidden"><div class="proj-type-accordion-toggle p-4 cursor-pointer flex justify-between items-center font-bold text-lg">${meta.icon}<span class="mr-3">${meta.name}</span><svg class="w-6 h-6 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg></div><div class="proj-type-accordion-content hidden p-2 space-y-2 bg-gray-50">${projectsHtml}</div></div>`; }); }
                document.getElementById('project-details-container')?.addEventListener('click', e => { const toggle = e.target.closest('.proj-type-accordion-toggle, .project-accordion-toggle'); if (toggle) { toggle.nextElementSibling?.classList.toggle('hidden'); toggle.querySelector('svg')?.classList.toggle('rotate-180'); } const addBtn = e.target.closest('.add-file-to-project-btn'); if (addBtn) openAddFileModal(addBtn.dataset.projectId, addBtn.dataset.docType); const viewBtn = e.target.closest('.view-doc-list-btn'); if (viewBtn) showDocumentListView(viewBtn.dataset.projectId, viewBtn.dataset.docType); });
                function showDocumentListView(projectId, docTypeKey) { document.getElementById('filtered-project-view').classList.add('hidden'); const docListView = document.getElementById('document-list-view'); docListView.classList.remove('hidden'); const project = projects.find(p => p.id == projectId); docListView.querySelector('#document-list-title').textContent = `${project.name} - ${docTypeMeta[docTypeKey].name}`; const documents = documentArchive.filter(d => project.docs.includes(d.id) && d.type === docTypeKey); const container = docListView.querySelector('#document-list-container'); container.innerHTML = documents.length > 0 ? `<div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">اسم الملف</th><th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">إجراء</th></tr></thead><tbody class="bg-white divide-y divide-gray-200">${documents.map(doc => `<tr><td class="px-6 py-4 whitespace-nowrap">${doc.name}</td><td class="px-6 py-4"><button class="view-doc text-blue-600" data-doc-id="${doc.id}">عرض</button></td></tr>`).join('')}</tbody></table></div>` : `<p class="text-center text-gray-500 p-8">لا توجد مستندات.</p>`; }
                document.getElementById('back-to-project-details')?.addEventListener('click', () => { document.getElementById('document-list-view').classList.add('hidden'); document.getElementById('filtered-project-view').classList.remove('hidden'); });
                document.getElementById('document-list-container')?.addEventListener('click', e => { if (e.target.classList.contains('view-doc')) { handleDocumentClick(e.target.dataset.docId); } });
                function handleDocumentClick(docId) { const doc = documentArchive.find(d => d.id == docId); if (!doc) return; const modal = document.getElementById('documentViewModal'); const viewer = document.getElementById('document-viewer-content'); const title = document.getElementById('document-view-title'); const downloadBtn = document.getElementById('downloadDocumentBtn'); title.textContent = doc.name; viewer.innerHTML = ''; downloadBtn.onclick = () => { if (!doc.content) { alert("لا يوجد محتوى لتحميله."); return; } const a = document.createElement('a'); a.href = doc.content; a.download = doc.name; document.body.appendChild(a); a.click(); document.body.removeChild(a); }; if (!doc.content) { viewer.innerHTML = `<p class="text-center text-gray-500">لا يوجد محتوى للمعاينة. يرجى تحميل الملف.</p>`; modal.classList.remove('hidden'); return; } const fileType = doc.fileType || ''; const base64Data = doc.content.split(',')[1] || ''; if (fileType.startsWith('image/')) { viewer.innerHTML = `<img src="${doc.content}" alt="${doc.name}" class="max-w-full h-auto rounded-lg mx-auto">`; } else if (fileType === 'application/pdf') { viewer.innerHTML = `<iframe src="${doc.content}" class="w-full h-full min-h-[70vh]" frameborder="0"></iframe>`; } else if (fileType === 'application/json' || fileType.startsWith('text/')) { try { const textContent = b64DecodeUnicode(base64Data); if (fileType === 'application/json') { const jsonObj = JSON.parse(textContent); viewer.innerHTML = `<pre class="text-left bg-gray-800 text-white p-4 rounded-lg overflow-x-auto" dir="ltr"><code>${JSON.stringify(jsonObj, null, 2)}</code></pre>`; } else { viewer.innerHTML = `<pre class="whitespace-pre-wrap text-right bg-gray-100 p-4 rounded-lg">${textContent}</pre>`; } } catch (e) { console.error("Error decoding/parsing text content:", e); viewer.innerHTML = `<p class="text-center text-red-500">خطأ في عرض الملف.</p>`; } } else { viewer.innerHTML = `<div class="text-center p-8"><p class="text-lg font-semibold text-gray-700">لا تتوفر معاينة لهذا النوع من الملفات.</p><p class="text-gray-500 mt-2">نوع الملف: ${fileType || 'غير معروف'}</p></div>`; } modal.classList.remove('hidden'); }
                function openAddFileModal(projectId, docType) { currentAddFileContext = { projectId, docType }; const modal = document.getElementById('addFileModal'); modal.querySelector('#addFileModalTitle').textContent = `إرفاق ملفات لـ: ${docTypeMeta[docType].name}`; modal.querySelector('#attachFileInput').value = ''; modal.querySelector('#file-preview-list').innerHTML = ''; modal.classList.remove('hidden'); }
                document.getElementById('attachFileInput')?.addEventListener('change', (e) => { const fileList = e.target.files; const previewContainer = document.getElementById('file-preview-list'); previewContainer.innerHTML = ''; if(fileList.length > 0) { previewContainer.innerHTML = Array.from(fileList).map(file => `<div class="text-sm p-2 bg-gray-100 rounded">${file.name}</div>`).join(''); } });
                document.getElementById('addFileForm')?.addEventListener('submit', (e) => { e.preventDefault(); const { projectId, docType } = currentAddFileContext; const fileInput = document.getElementById('attachFileInput'); const files = fileInput.files; if (files.length === 0) { alert('الرجاء تحديد ملف واحد على الأقل.'); return; } let filesProcessed = 0; for (let i = 0; i < files.length; i++) { const file = files[i]; const reader = new FileReader(); reader.onload = (event) => { const newDoc = { id: Date.now() + Math.random(), projectId: parseInt(projectId), type: docType, name: file.name, fileType: file.type, content: event.target.result, addedBy: currentUser.name, addedDate: new Date() }; documentArchive.push(newDoc); logActivity('المستندات', file.name, 'إضافة', `تمت إضافة الملف إلى مشروع ID ${projectId}`); const project = projects.find(p => p.id == projectId); if (project) { project.docs.push(newDoc.id); } filesProcessed++; if(filesProcessed === files.length) { renderProjectDetails(); document.getElementById('addFileModal').classList.add('hidden'); } }; reader.readAsDataURL(file); } });

                // ===== TENDERING PAGE - BOQ ITEMS (Unchanged) =====
                document.getElementById('show-boq-items-page')?.addEventListener('click', () => { showPage('boq-items-page'); });
                document.querySelectorAll('.back-to-tendering-cards').forEach(btn => btn.addEventListener('click', () => showPage('tendering-sub')));
                const boqItemModal = document.getElementById('addBoqItemModal'), boqItemForm = document.getElementById('addBoqItemForm'), boqItemsTableBody = document.getElementById('boq-items-table-body');
                function exportToExcel(data, filename) { const headers = {"number":"رقم البند", "name":"اسم البند", "unit":"وحدة القياس", "price":"السعر التقديري", "scope":"بيان الأعمال", "category":"الفئة", "specialization":"التخصص"}; const dataToExport = data.map(item => Object.keys(headers).reduce((obj, key) => ({...obj, [headers[key]]: item[key]}), {})); const ws = XLSX.utils.json_to_sheet(dataToExport); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Sheet1"); XLSX.writeFile(wb, `${filename}.xlsx`); }
                function updateExportSelectedButton() { const selectedCheckboxes = document.querySelectorAll('.boq-item-checkbox:checked'); document.getElementById('boq-export-selected').disabled = selectedCheckboxes.length === 0; }
                function renderBoqItemsTable() { if (!boqItemsTableBody) return; boqItemsTableBody.innerHTML = boqItems.map(item => `<tr><td class="px-2"><input type="checkbox" class="boq-item-checkbox" data-id="${item.id}"></td><td>${item.number}</td><td>${item.name}</td><td>${item.unit}</td><td>${item.price}</td><td class="max-w-xs truncate" title="${item.scope}">${item.scope}</td><td>${item.category}</td><td>${item.specialization}</td><td class="space-x-2 space-x-reverse whitespace-nowrap"><button class="edit-boq-item-btn text-blue-600 hover:text-blue-800" data-id="${item.id}">تعديل</button><button class="delete-boq-item-btn text-red-600 hover:text-red-800" data-id="${item.id}">حذف</button></td></tr>`).join(''); updateExportSelectedButton(); }
                document.getElementById('add-boq-item-btn')?.addEventListener('click', () => { boqItemForm.reset(); document.getElementById('boqItemId').value = ''; document.getElementById('boqItemModalTitle').textContent = 'إضافة بند جديد'; boqItemModal.classList.remove('hidden'); });
                document.getElementById('boq-export-all')?.addEventListener('click', () => { exportToExcel(boqItems, 'جميع_البنود'); });
                document.getElementById('boq-export-selected')?.addEventListener('click', () => { const selectedIds = Array.from(document.querySelectorAll('.boq-item-checkbox:checked')).map(cb => parseInt(cb.dataset.id)); const selectedItems = boqItems.filter(item => selectedIds.includes(item.id)); exportToExcel(selectedItems, 'البنود_المحددة'); });
                function promptBoqItemDelete(itemId) { const confirmationModal = document.getElementById('confirmationModal'); const confirmBtn = document.getElementById('confirmDeleteBtn'); const cancelBtn = document.getElementById('cancelDeleteBtn'); const item = boqItems.find(i => i.id == itemId); if (!item) return; document.getElementById('confirmationModalTitle').textContent = `تأكيد حذف البند`; document.getElementById('confirmationModalText').textContent = `هل أنت متأكد من رغبتك في حذف "${item.name}"؟ لا يمكن التراجع عن هذا الإجراء.`; confirmBtn.onclick = () => { boqItems = boqItems.filter(i => i.id != itemId); renderBoqItemsTable(); confirmationModal.classList.add('hidden'); }; cancelBtn.onclick = () => { confirmationModal.classList.add('hidden'); }; confirmationModal.classList.remove('hidden'); }
                boqItemsTableBody?.addEventListener('click', (e) => { if (e.target.classList.contains('edit-boq-item-btn')) { const itemId = parseInt(e.target.dataset.id); const item = boqItems.find(i => i.id === itemId); if (item) { document.getElementById('boqItemId').value = item.id; document.getElementById('boqItemModalTitle').textContent = 'تعديل بند'; document.getElementById('boqItemNumber').value = item.number; document.getElementById('boqItemName').value = item.name; document.getElementById('boqItemUnit').value = item.unit; document.getElementById('boqItemPrice').value = item.price; document.getElementById('boqItemScope').value = item.scope; document.getElementById('boqItemCategory').value = item.category; document.getElementById('boqItemSpecialization').value = item.specialization; boqItemModal.classList.remove('hidden'); } } if (e.target.classList.contains('delete-boq-item-btn')) { const itemId = parseInt(e.target.dataset.id); promptBoqItemDelete(itemId); } });
                boqItemForm?.addEventListener('submit', (e) => { e.preventDefault(); const id = document.getElementById('boqItemId').value; const itemData = { number: document.getElementById('boqItemNumber').value, name: document.getElementById('boqItemName').value, unit: document.getElementById('boqItemUnit').value, price: parseFloat(document.getElementById('boqItemPrice').value), scope: document.getElementById('boqItemScope').value, category: document.getElementById('boqItemCategory').value, specialization: document.getElementById('boqItemSpecialization').value, }; if (id) { const index = boqItems.findIndex(item => item.id == id); if (index > -1) { boqItems[index] = { ...boqItems[index], ...itemData }; } } else { boqItems.push({ id: Date.now(), ...itemData }); } renderBoqItemsTable(); boqItemModal.classList.add('hidden'); });
                boqItemsTableBody?.addEventListener('change', (e) => { if (e.target.classList.contains('boq-item-checkbox')) { updateExportSelectedButton(); } });
                document.getElementById('boq-select-all-checkbox')?.addEventListener('change', (e) => { document.querySelectorAll('.boq-item-checkbox').forEach(checkbox => { checkbox.checked = e.target.checked; }); updateExportSelectedButton(); });
                const excelFileInput = document.getElementById('excel-file-input');
                document.getElementById('boq-import-excel').addEventListener('click', () => { excelFileInput.click(); });
                excelFileInput.addEventListener('change', (event) => { const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (e) => { try { const data = new Uint8Array(e.target.result); const workbook = XLSX.read(data, { type: 'array' }); const firstSheetName = workbook.SheetNames[0]; const worksheet = workbook.Sheets[firstSheetName]; const json = XLSX.utils.sheet_to_json(worksheet); const headerMapping = { 'رقم البند': 'number', 'اسم البند': 'name', 'وحدة القياس': 'unit', 'السعر التقديري': 'price', 'بيان الأعمال': 'scope', 'الفئة': 'category', 'التخصص': 'specialization' }; json.forEach(row => { const newItem = { id: Date.now() + Math.random() }; let hasData = false; for (const excelHeader in headerMapping) { if (row[excelHeader] !== undefined) { newItem[headerMapping[excelHeader]] = row[excelHeader]; hasData = true; } } if(hasData) boqItems.push(newItem); }); renderBoqItemsTable(); alert(`تم استيراد ${json.length} بند بنجاح.`); } catch (error) { console.error("Error processing Excel file:", error); alert("حدث خطأ أثناء معالجة ملف Excel. يرجى التأكد من تنسيق الملف."); } finally { event.target.value = ''; } }; reader.readAsArrayBuffer(file); });

                // ===== TENDERING PAGE - BOQ TEMPLATES (NEW LOGIC) =====
                
                // --- Tafqit (Number to Arabic Text) Library ---
                const Tafqit = new (function () {
                    const const_n0 = ["صفر", "واحد", "اثنان", "ثلاثة", "أربعة", "خمسة", "ستة", "سبعة", "ثمانية", "تسعة", "عشرة", "أحد عشر", "اثنا عشر", "ثلاثة عشر", "أربعة عشر", "خمسة عشر", "ستة عشر", "سبعة عشر", "ثمانية عشر", "تسعة عشر"];
                    const const_n1 = ["", "", "عشرون", "ثلاثون", "أربعون", "خمسون", "ستون", "سبعون", "ثمانون", "تسعون"];
                    const const_n2 = ["", "مئة", "مئتان", "ثلاثمائة", "أربعمائة", "خمسمائة", "ستمائة", "سبعمائة", "ثمانمائة", "تسعمائة"];
                    const const_n3 = [{s: "مليار", p: "مليارات"}, {s: "مليون", p: "ملايين"}, {s: "ألف", p: "آلاف"}, {s: "", p: ""}];

                    function convert999(num) {
                        let c1 = parseInt(num[0]); // hundreds
                        let c2 = parseInt(num[1]); // tens
                        let c3 = parseInt(num[2]); // ones
                        let c23 = parseInt(num.substr(1));
                        
                        let text = "";

                        if (c1 > 0) {
                            text = const_n2[c1];
                        }
                        
                        if (c23 > 0) {
                             if(c1 > 0) text += " و";
                            if (c23 < 20) {
                                text += const_n0[c23];
                            } else {
                                if (c3 > 0) text += const_n0[c3];
                                if (c2 > 0) {
                                    if(c3 > 0) text += " و";
                                    text += const_n1[c2];
                                }
                            }
                        }
                        return text;
                    }

                    function int2Text(num_str) {
                        if (num_str == "0") return const_n0[0];
                        let g = Math.floor(num_str.length / 3) + (num_str.length % 3 > 0 ? 1 : 0);
                        if (num_str.length % 3 !== 0) num_str = ("00" + num_str).slice(-g * 3);
                        
                        let parts = [];
                        for (let i = 0; i < g; i++) {
                            let c_str = num_str.substr(i * 3, 3);
                            let c_num = parseInt(c_str);
                            if (c_num === 0) continue;
                            
                            let text = convert999(c_str);
                            
                            let p = g - i - 1;
                            if (p > 0) { // thousands, millions...
                                if(c_num === 1) {
                                    text = const_n3[p].s;
                                } else if (c_num === 2) {
                                    text = const_n3[p].s === 'ألف' ? 'ألفان' : const_n3[p].s.replace(/.$/,"ان");
                                } else if (c_num >= 3 && c_num <= 10) {
                                     text += " " + const_n3[p].p;
                                } else {
                                     text += " " + const_n3[p].s;
                                }
                            }
                            parts.push(text);
                        }
                        return parts.join(" و");
                    }

                    this.toText = function (num, options) {
                        options = options || {};
                        if (num === null || isNaN(num)) return "";
                        
                        let numStr = parseFloat(num).toFixed(2);
                        
                        const parts = numStr.split('.');
                        const intPart = parts[0];
                        const decPart = parts[1];
                        
                        let result = int2Text(intPart);

                        if (options.currency) {
                            if (result) result += " " + (options.currency.singular || "ريال");
                            else if(parseInt(decPart) === 0) return "صفر ريال";

                            if (decPart && parseInt(decPart) > 0) {
                                if(intPart != '0') result += " و";
                                result += int2Text(decPart) + " " + (options.currency.fraction || "هللة");
                            }
                        }
                        return result;
                    };
                })();

                function showBoqTemplatesListView() {
                    document.getElementById('boq-templates-list-view').classList.remove('hidden');
                    document.getElementById('boq-template-editor-view').classList.add('hidden');
                    document.getElementById('boq-editor-top-buttons').classList.add('hidden');
                    pageTitle.textContent = 'قوالب جدول الكميات';
                    renderBoqTemplatesList();
                }

                function showBoqTemplateEditorView(templateId = 'new', isViewOnly = false) {
                    currentEditingTemplateId = templateId;
                    document.getElementById('boq-templates-list-view').classList.add('hidden');
                    document.getElementById('boq-template-editor-view').classList.remove('hidden');
                    document.getElementById('boq-editor-top-buttons').classList.remove('hidden');
                    
                    const boqTemplateNameInput = document.getElementById('boqTemplateName');
                    const boqTemplateCategorySelect = document.getElementById('boqTemplateCategory');
                    const boqTemplateSpecializationSelect = document.getElementById('boqTemplateSpecialization');
                    
                    let template;
                    if (templateId === 'new') {
                        isViewOnly = false; // Cannot view a new template
                        pageTitle.textContent = 'إنشاء جدول كميات جديد';
                        boqTemplateNameInput.value = '';
                        boqTemplateCategorySelect.value = availableCategories[0];
                        boqTemplateSpecializationSelect.value = availableSpecializations[0];
                        currentBoqTemplateData = [];
                        addBoqTemplateRowData();
                    } else {
                        template = boqTemplates.find(t => t.id == templateId);
                        if(template) {
                            pageTitle.textContent = `${isViewOnly ? 'عرض' : 'تعديل'}: ${template.name}`;
                            boqTemplateNameInput.value = template.name;
                            boqTemplateCategorySelect.value = template.category;
                            boqTemplateSpecializationSelect.value = template.specialization;
                            currentBoqTemplateData = JSON.parse(JSON.stringify(template.items));
                        }
                    }
                    currentBoqTemplatePage = 1;
                    renderBoqTemplatePage();

                    // Apply view/edit mode after rendering
                    const editorView = document.getElementById('boq-template-editor-view');
                    editorView.querySelectorAll('input, select').forEach(el => {
                        if (el.id === 'boqTemplateName' || el.id === 'boqTemplateCategory' || el.id === 'boqTemplateSpecialization') {
                            el.disabled = isViewOnly;
                        } else if (!el.classList.contains('readonly')) {
                             el.disabled = isViewOnly;
                        }
                    });
                     
                    document.getElementById('boq-editor-actions').style.display = isViewOnly ? 'none' : 'flex';
                    document.getElementById('boq-editor-save-actions').style.display = isViewOnly ? 'none' : 'flex';
                    const searchInput = document.getElementById('boqSearch');
                     if(searchInput) searchInput.disabled = isViewOnly;

                }

                function renderBoqTemplatesList() {
                    const container = document.getElementById('boq-templates-list');
                    if(boqTemplates.length === 0) {
                        container.innerHTML = `<p class="text-gray-500">لا توجد قوالب محفوظة.</p>`;
                        return;
                    }
                    container.innerHTML = boqTemplates.map(template => `
                        <div class="bg-gray-50 p-3 rounded-lg flex justify-between items-center border">
                            <div>
                                <h4 class="font-bold">${template.name}</h4>
                                <p class="text-sm text-gray-500">${template.category} - ${template.specialization}</p>
                            </div>
                            <div class="space-x-2 space-x-reverse">
                                <button class="view-boq-template-btn text-green-600 hover:text-green-800" data-template-id="${template.id}">عرض</button>
                                <button class="edit-boq-template-btn text-blue-600 hover:text-blue-800" data-template-id="${template.id}">تعديل</button>
                                <button class="delete-boq-template-btn text-red-600 hover:text-red-800" data-template-id="${template.id}">حذف</button>
                            </div>
                        </div>
                    `).join('');
                }

                function renderBoqTemplatePage() {
                    const tableBody = document.getElementById('boq-template-table')?.querySelector('tbody');
                    if (!tableBody) return;
                    tableBody.innerHTML = '';
                    
                    const startIndex = (currentBoqTemplatePage - 1) * BOQ_ROWS_PER_PAGE;
                    const endIndex = startIndex + BOQ_ROWS_PER_PAGE;
                    const pageItems = currentBoqTemplateData.slice(startIndex, endIndex);

                    pageItems.forEach((item, index) => {
                        const globalIndex = startIndex + index;
                        const row = document.createElement('tr');
                        row.dataset.index = globalIndex;
                        row.innerHTML = `
                            <td><input type="checkbox" class="boq-template-item-checkbox" data-index="${globalIndex}"></td>
                            <td><input type="text" data-col="itemCode" value="${item.itemCode || ''}"></td>
                            <td><input type="text" data-col="itemNumber" value="${item.itemNumber || ''}"></td>
                            <td><input type="text" data-col="scope" value="${item.scope || ''}"></td>
                            <td><input type="text" data-col="itemCategory" value="${item.itemCategory || ''}"></td>
                            <td><input type="text" data-col="unit" value="${item.unit || ''}"></td>
                            <td><input type="number" step="any" data-col="quantity" value="${item.quantity || ''}"></td>
                            <td><input type="number" step="any" data-col="unitPriceNum" value="${item.unitPriceNum || ''}"></td>
                            <td><input type="text" data-col="unitPriceText" value="${item.unitPriceText || ''}" class="readonly" readonly></td>
                            <td><input type="text" data-col="totalPriceNum" value="${item.totalPriceNum || ''}" class="readonly" readonly></td>
                            <td><input type="text" data-col="totalPriceText" value="${item.totalPriceText || ''}" class="readonly" readonly></td>
                            <td><button class="delete-boq-template-row text-red-500 font-bold" data-index="${globalIndex}">✕</button></td>
                        `;
                        tableBody.appendChild(row);
                    });
                    updateBoqTemplateTotalsAndPagination();
                }
                
                function updateBoqTemplateTotalsAndPagination() {
                    const totalItems = currentBoqTemplateData.length;
                    const totalPages = Math.max(1, Math.ceil(totalItems / BOQ_ROWS_PER_PAGE));
                    
                    document.getElementById('boq-item-count').textContent = totalItems;
                    document.getElementById('boq-current-page').textContent = currentBoqTemplatePage;
                    document.getElementById('boq-total-pages').textContent = totalPages;

                    document.getElementById('boq-prev-page').disabled = currentBoqTemplatePage === 1;
                    document.getElementById('boq-next-page').disabled = currentBoqTemplatePage === totalPages;

                    const grandTotal = currentBoqTemplateData.reduce((sum, item) => sum + (parseFloat(item.totalPriceNum) || 0), 0);
                    document.getElementById('boq-grand-total').textContent = `${grandTotal.toFixed(2)} ريال`;
                }
                
                function addBoqTemplateRowData() {
                    currentBoqTemplateData.push({ id: Date.now() + Math.random(), itemCode: '', itemNumber: '', scope: '', itemCategory: '', unit: '', quantity: '', unitPriceNum: '', unitPriceText: '', totalPriceNum: '', totalPriceText: '' });
                    currentBoqTemplatePage = Math.ceil(currentBoqTemplateData.length / BOQ_ROWS_PER_PAGE); // Go to last page
                    renderBoqTemplatePage();
                }

                function calculateAndUpdateRow(rowElement, rowIndex) {
                    const item = currentBoqTemplateData[rowIndex];
                    if (!item) return;

                    const quantity = parseFloat(item.quantity) || 0;
                    const unitPrice = parseFloat(item.unitPriceNum) || 0;
                    const totalPrice = quantity * unitPrice;

                    item.totalPriceNum = totalPrice.toFixed(2);
                    item.unitPriceText = Tafqit.toText(unitPrice, { currency: { singular: 'ريال', fraction: 'هللة' } });
                    item.totalPriceText = Tafqit.toText(totalPrice, { currency: { singular: 'ريال', fraction: 'هللة' } });
                    
                    // Update DOM directly
                    rowElement.querySelector('[data-col="unitPriceText"]').value = item.unitPriceText;
                    rowElement.querySelector('[data-col="totalPriceNum"]').value = item.totalPriceNum;
                    rowElement.querySelector('[data-col="totalPriceText"]').value = item.totalPriceText;

                    updateBoqTemplateTotalsAndPagination();
                }
                
                document.getElementById('boq-template-table')?.querySelector('tbody').addEventListener('change', e => {
                    const input = e.target;
                    const row = input.closest('tr');
                    const col = input.dataset.col;
                    if(!row) return;
                    const rowIndex = parseInt(row.dataset.index);
                    
                    if (!isNaN(rowIndex) && currentBoqTemplateData[rowIndex]) {
                         currentBoqTemplateData[rowIndex][col] = input.value;
                        if (col === 'quantity' || col === 'unitPriceNum') {
                            calculateAndUpdateRow(row, rowIndex);
                        }
                    }
                });
                
                document.getElementById('addBoqTemplateRow').addEventListener('click', addBoqTemplateRowData);
                
                document.getElementById('boq-template-table')?.querySelector('tbody').addEventListener('click', e => {
                    if (e.target.classList.contains('delete-boq-template-row')) {
                        const rowIndex = parseInt(e.target.dataset.index);
                        currentBoqTemplateData.splice(rowIndex, 1);
                        if(currentBoqTemplatePage > 1 && (currentBoqTemplatePage - 1) * BOQ_ROWS_PER_PAGE >= currentBoqTemplateData.length) {
                            currentBoqTemplatePage--;
                        }
                        renderBoqTemplatePage();
                    }
                });

                document.getElementById('boq-prev-page').addEventListener('click', () => { if (currentBoqTemplatePage > 1) { currentBoqTemplatePage--; renderBoqTemplatePage(); } });
                document.getElementById('boq-next-page').addEventListener('click', () => { const totalPages = Math.ceil(currentBoqTemplateData.length / BOQ_ROWS_PER_PAGE); if (currentBoqTemplatePage < totalPages) { currentBoqTemplatePage++; renderBoqTemplatePage(); } });
                
                document.getElementById('show-boq-templates-page')?.addEventListener('click', () => { showPage('boq-templates-page'); });
                document.getElementById('show-boq-template-editor-btn').addEventListener('click', () => showBoqTemplateEditorView('new'));
                document.querySelector('.back-to-boq-templates-list')?.addEventListener('click', showBoqTemplatesListView);
                document.getElementById('cancel-boq-template').addEventListener('click', showBoqTemplatesListView);

                document.getElementById('save-boq-template').addEventListener('click', () => {
                    const name = document.getElementById('boqTemplateName').value;
                    const category = document.getElementById('boqTemplateCategory').value;
                    const specialization = document.getElementById('boqTemplateSpecialization').value;
                    
                    if(!name) { alert('الرجاء إدخال اسم للجدول.'); return; }
                    
                    const templateData = { name, category, specialization, items: currentBoqTemplateData };

                    if (currentEditingTemplateId === 'new') {
                        templateData.id = Date.now();
                        boqTemplates.push(templateData);
                        logActivity('قوالب جدول الكميات', name, 'إضافة', `تم إنشاء قالب جديد`);
                    } else {
                        const index = boqTemplates.findIndex(t => t.id == currentEditingTemplateId);
                        if (index !== -1) {
                            boqTemplates[index] = { ...boqTemplates[index], ...templateData };
                             logActivity('قوالب جدول الكميات', name, 'تعديل', `تم تعديل القالب`);
                        }
                    }
                    showBoqTemplatesListView();
                });

                document.getElementById('boq-templates-list').addEventListener('click', e => {
                    if (e.target.classList.contains('edit-boq-template-btn')) {
                        showBoqTemplateEditorView(e.target.dataset.templateId, false);
                    }
                    if (e.target.classList.contains('view-boq-template-btn')) {
                        showBoqTemplateEditorView(e.target.dataset.templateId, true);
                    }
                    // Add delete logic here if needed
                });
                
                // EXCEL Import/Export for BOQ Templates
                const excelTemplateFileInput = document.getElementById('excel-template-file-input');

                function exportTemplateToExcel(data, filename) {
                    const headers = {"itemCode":"كود البند", "itemNumber":"رقم البند", "scope":"بيان الأعمال", "itemCategory":"فئة البند", "unit":"الوحدة", "quantity":"الكمية", "unitPriceNum":"السعر الإفرادي (رقماً)"};
                    const dataToExport = data.map(item => Object.keys(headers).reduce((obj, key) => ({...obj, [headers[key]]: item[key]}), {}));
                    const ws = XLSX.utils.json_to_sheet(dataToExport);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, "BOQ Template");
                    XLSX.writeFile(wb, `${filename}.xlsx`);
                }

                function updateTemplateExportSelectedButton() {
                    const selectedCheckboxes = document.querySelectorAll('.boq-template-item-checkbox:checked');
                    document.getElementById('boq-template-export-selected').disabled = selectedCheckboxes.length === 0;
                }
                
                document.getElementById('boq-template-table')?.addEventListener('change', e => {
                     if (e.target.classList.contains('boq-template-item-checkbox') || e.target.id === 'boq-template-select-all') {
                         updateTemplateExportSelectedButton();
                     }
                });
                
                document.getElementById('boq-template-select-all')?.addEventListener('change', (e) => {
                    document.querySelectorAll('.boq-template-item-checkbox').forEach(checkbox => {
                        checkbox.checked = e.target.checked;
                    });
                    updateTemplateExportSelectedButton();
                });

                document.getElementById('boq-template-export-all')?.addEventListener('click', () => {
                    const name = document.getElementById('boqTemplateName').value || 'template';
                    exportTemplateToExcel(currentBoqTemplateData, name);
                });

                document.getElementById('boq-template-export-selected')?.addEventListener('click', () => {
                    const selectedIndices = Array.from(document.querySelectorAll('.boq-template-item-checkbox:checked')).map(cb => parseInt(cb.dataset.index));
                    const selectedItems = currentBoqTemplateData.filter((item, index) => selectedIndices.includes(index));
                    const name = document.getElementById('boqTemplateName').value || 'template-selection';
                    exportTemplateToExcel(selectedItems, name);
                });

                document.getElementById('boq-template-import-excel').addEventListener('click', () => {
                    excelTemplateFileInput.click();
                });

                excelTemplateFileInput.addEventListener('change', (event) => {
                    const file = event.target.files[0];
                    if (!file) return;

                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const data = new Uint8Array(e.target.result);
                            const workbook = XLSX.read(data, { type: 'array' });
                            const firstSheetName = workbook.SheetNames[0];
                            const worksheet = workbook.Sheets[firstSheetName];
                            const json = XLSX.utils.sheet_to_json(worksheet);
                            
                            const headerMapping = { "كود البند": "itemCode", "رقم البند": "itemNumber", "بيان الأعمال": "scope", "فئة البند": "itemCategory", "الوحدة": "unit", "الكمية": "quantity", "السعر الإفرادي (رقماً)": "unitPriceNum" };
                            
                            const newItems = json.map(row => {
                                const newItem = { id: Date.now() + Math.random() };
                                for (const excelHeader in headerMapping) {
                                    if (row[excelHeader] !== undefined) {
                                        newItem[headerMapping[excelHeader]] = row[excelHeader];
                                    }
                                }
                                return newItem;
                            });

                            currentBoqTemplateData.push(...newItems);
                            renderBoqTemplatePage();
                            alert(`تم استيراد ${json.length} بند بنجاح.`);

                        } catch (error) {
                            console.error("Error processing Excel file:", error);
                            alert("حدث خطأ أثناء معالجة ملف Excel. يرجى التأكد من تنسيق الملف وتطابق الأعمدة.");
                        } finally {
                            event.target.value = ''; // Reset file input
                        }
                    };
                    reader.readAsArrayBuffer(file);
                });
                
                // KARRASA PAGE LOGIC
                document.getElementById('show-karrasa-page')?.addEventListener('click', () => {
                     document.getElementById('tendering-cards-view').classList.add('hidden');
                     showPage('karrasa-page');
                });
                
                 function showKarrasaListView() {
                    document.getElementById('karrasa-list-view').classList.remove('hidden');
                    document.getElementById('karrasa-editor-view').classList.add('hidden');
                    pageTitle.textContent = 'إدارة كراسات الشروط';
                    renderKarrasaList();
                }

                function showKarrasaEditorView(karrasaId = 'new') {
                    document.getElementById('karrasa-list-view').classList.add('hidden');
                    document.getElementById('karrasa-editor-view').classList.remove('hidden');
                    currentEditingKarrasaId = karrasaId;

                    const nameInput = document.getElementById('karrasaName');
                    const contentInput = document.getElementById('karrasaContent');

                    if(karrasaId === 'new') {
                        nameInput.value = '';
                        contentInput.value = '';
                    } else {
                        const karrasa = karrasaTemplates.find(k => k.id == karrasaId);
                        if(karrasa) {
                            nameInput.value = karrasa.name;
                            contentInput.value = karrasa.content;
                        }
                    }
                }
                
                function renderKarrasaList() {
                    const container = document.getElementById('karrasa-list');
                    if (karrasaTemplates.length === 0) {
                        container.innerHTML = `<p class="text-gray-500">لا توجد كراسات محفوظة.</p>`;
                        return;
                    }
                    container.innerHTML = karrasaTemplates.map(k => `
                        <div class="bg-gray-50 p-3 rounded-lg flex justify-between items-center border">
                            <h4 class="font-bold">${k.name}</h4>
                            <div class="space-x-2 space-x-reverse">
                                 <button class="edit-karrasa-btn text-blue-600 hover:text-blue-800" data-id="${k.id}">تعديل</button>
                                 <button class="delete-karrasa-btn text-red-600 hover:text-red-800" data-id="${k.id}">حذف</button>
                            </div>
                        </div>
                    `).join('');
                }
                
                document.getElementById('add-new-karrasa-btn')?.addEventListener('click', () => showKarrasaEditorView('new'));
                document.getElementById('cancel-karrasa-edit')?.addEventListener('click', showKarrasaListView);
                
                document.getElementById('karrasa-list').addEventListener('click', e => {
                    const editBtn = e.target.closest('.edit-karrasa-btn');
                    if (editBtn) {
                        showKarrasaEditorView(editBtn.dataset.id);
                    }
                    // Add delete logic here
                });
                
                document.getElementById('save-karrasa-edit').addEventListener('click', () => {
                     const name = document.getElementById('karrasaName').value;
                     const content = document.getElementById('karrasaContent').value;
                     if (!name) { alert("الرجاء إدخال اسم للكراسة."); return; }
                     
                     if (currentEditingKarrasaId === 'new') {
                         karrasaTemplates.push({ id: Date.now(), name, content });
                         logActivity('كراسات الشروط', name, 'إضافة', `تم إنشاء كراسة جديدة`);
                     } else {
                         const index = karrasaTemplates.findIndex(k => k.id == currentEditingKarrasaId);
                         if(index !== -1) {
                             karrasaTemplates[index].name = name;
                             karrasaTemplates[index].content = content;
                              logActivity('كراسات الشروط', name, 'تعديل', `تم تعديل الكراسة`);
                         }
                     }
                     showKarrasaListView();
                });
                
                // Word Import/Export
                const wordFileInput = document.getElementById('word-file-input');
                document.getElementById('karrasa-import-word').addEventListener('click', () => wordFileInput.click());
                document.getElementById('karrasa-export-word').addEventListener('click', () => {
                    const name = document.getElementById('karrasaName').value || 'karrasa';
                    const content = document.getElementById('karrasaContent').value;
                    const blob = new Blob([content], { type: 'application/msword;charset=utf-8' });
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = `${name}.doc`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                });
                wordFileInput.addEventListener('change', (event) => {
                    const file = event.target.files[0];
                    if (!file) return;

                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const arrayBuffer = e.target.result;
                        
                        // Use mammoth.js to extract text
                        mammoth.extractRawText({ arrayBuffer: arrayBuffer })
                            .then(function(result){
                                const text = result.value; // The raw text
                                document.getElementById('karrasaContent').value = text;
                            })
                            .catch(function(err) {
                                console.error('Error reading docx file:', err);
                                alert('حدث خطأ أثناء قراءة الملف. يرجى التأكد من أنه ملف Word (.docx) صالح.');
                            });
                    };
                    
                    reader.onerror = function(err) {
                        console.error('FileReader error:', err);
                        alert('حدث خطأ أثناء قراءة الملف.');
                    };

                    reader.readAsArrayBuffer(file);
                    event.target.value = ''; // Reset file input
                });

                
                // ARCHIVE PAGE LOGIC
                function renderArchivePage(searchTerm = '') {
                    const tableBody = document.getElementById('archive-table-body');
                    if (!tableBody) return;

                    const lowerCaseSearchTerm = searchTerm.toLowerCase();

                    const filteredDocs = documentArchive.filter(doc => {
                        const project = projects.find(p => p.id === doc.projectId);
                        return doc.name.toLowerCase().includes(lowerCaseSearchTerm) ||
                               doc.addedBy.toLowerCase().includes(lowerCaseSearchTerm) ||
                               (project && project.name.toLowerCase().includes(lowerCaseSearchTerm)) ||
                               (project && project.status.toLowerCase().includes(lowerCaseSearchTerm));
                    });

                    tableBody.innerHTML = filteredDocs.map(doc => {
                        const project = projects.find(p => p.id === doc.projectId);
                        const projectName = project ? project.name : 'غير محدد';
                        const projectStatus = project ? project.status : 'غير محدد';
                        const formattedDate = new Date(doc.addedDate).toLocaleDateString('ar-EG-u-nu-latn', { year: 'numeric', month: 'long', day: 'numeric' });

                        return `
                            <tr>
                                <td>${doc.name}</td>
                                <td>${projectName}</td>
                                <td>${projectStatus}</td>
                                <td>${doc.addedBy}</td>
                                <td>${formattedDate}</td>
                                <td class="space-x-2 space-x-reverse whitespace-nowrap">
                                    <button class="view-doc-archive text-blue-600 hover:text-blue-800" data-doc-id="${doc.id}">عرض</button>
                                    <button class="download-doc-archive text-green-600 hover:text-green-800" data-doc-id="${doc.id}">تحميل</button>
                                </td>
                            </tr>
                        `;
                    }).join('');
                     if (filteredDocs.length === 0) {
                        tableBody.innerHTML = `<tr><td colspan="6" class="text-center p-4 text-gray-500">لا توجد مستندات تطابق البحث.</td></tr>`;
                    }
                }
                
                document.getElementById('archive-search')?.addEventListener('input', e => {
                    renderArchivePage(e.target.value);
                });

                document.getElementById('archive-table-body')?.addEventListener('click', e => {
                    const viewBtn = e.target.closest('.view-doc-archive');
                    const downloadBtn = e.target.closest('.download-doc-archive');

                    if(viewBtn) {
                        handleDocumentClick(viewBtn.dataset.docId);
                    } else if (downloadBtn) {
                        const docId = downloadBtn.dataset.docId;
                        const doc = documentArchive.find(d => d.id == docId);
                        if (doc && doc.content) {
                             const a = document.createElement('a');
                             a.href = doc.content;
                             a.download = doc.name;
                             document.body.appendChild(a);
                             a.click();
                             document.body.removeChild(a);
                        } else {
                            alert('لا يوجد محتوى لهذا الملف للتحميل.');
                        }
                    }
                });

                 // NOTIFICATIONS LOG PAGE LOGIC
                function renderNotificationsLogPage(searchTerm = '') {
                    const tableBody = document.getElementById('notifications-log-table-body');
                    if (!tableBody) return;

                    const lowerCaseSearchTerm = searchTerm.toLowerCase();

                    const filteredLogs = activityLog.filter(log => {
                        return Object.values(log).some(value => 
                            value.toString().toLowerCase().includes(lowerCaseSearchTerm)
                        );
                    });

                    if (filteredLogs.length === 0) {
                        tableBody.innerHTML = `<tr><td colspan="6" class="text-center p-4 text-gray-500">لا توجد سجلات.</td></tr>`;
                        return;
                    }

                    tableBody.innerHTML = filteredLogs.map(log => {
                        const formattedDate = new Date(log.date).toLocaleString('ar-EG', {
                            day: 'numeric',
                            month: 'long',
                            year: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        });

                        return `
                            <tr>
                                <td>${formattedDate}</td>
                                <td>${log.section}</td>
                                <td class="whitespace-normal">${log.item}</td>
                                <td>${log.action}</td>
                                <td>${log.user}</td>
                                <td class="whitespace-normal">${log.details}</td>
                            </tr>
                        `;
                    }).join('');
                }

                document.getElementById('notifications-search')?.addEventListener('input', e => {
                    renderNotificationsLogPage(e.target.value);
                });


                // ===== MODALS & GENERAL LISTENERS (Unchanged) =====
                document.getElementById('add-project-button')?.addEventListener('click', () => { const addProjectModal = document.getElementById('addProjectModal'); populateProjectTypeButtons(); renderAddProjectRegionButtons(); showProjectStep(0); addProjectModal.classList.remove('hidden'); });
                document.getElementById('add-category-button')?.addEventListener('click', () => { document.getElementById('addCategoryModal').classList.remove('hidden'); });
                document.getElementById('add-region-button')?.addEventListener('click', () => { document.getElementById('addRegionModal').classList.remove('hidden'); });
                let currentProjectStep = 0; const addProjectSteps = [ document.getElementById('add-project-step-1'), document.getElementById('add-project-step-2'), document.getElementById('add-project-step-3') ]; const backProjectBtn = document.getElementById('backAddProjectStep'); const submitProjectBtn = document.getElementById('submitAddProject');
                function showProjectStep(stepIndex) { addProjectSteps.forEach((step, index) => { step.classList.toggle('hidden', index !== stepIndex); }); backProjectBtn.classList.toggle('hidden', stepIndex === 0); submitProjectBtn.classList.toggle('hidden', stepIndex !== 2); currentProjectStep = stepIndex; }
                function populateProjectTypeButtons() { const container = document.getElementById('add-project-type-container'); container.innerHTML = ''; Object.keys(projTypeMeta).forEach(key => { const meta = projTypeMeta[key]; const button = document.createElement('button'); button.type = 'button'; button.className = 'add-project-type-btn step-choice-btn p-4 border rounded-lg flex flex-col items-center'; button.dataset.type = key; button.innerHTML = `<span class="text-4xl">${meta.icon}</span><span class="mt-2 font-semibold">${meta.name}</span>`; button.addEventListener('click', () => { newProjectData.type = key; showProjectStep(1); }); container.appendChild(button); }); }
                function renderAddProjectRegionButtons() { const container = document.getElementById('add-project-region-container'); container.innerHTML = ''; availableRegions.forEach(region => { const button = document.createElement('button'); button.type = 'button'; button.className = 'add-project-region-btn step-choice-btn p-4 border rounded-lg'; button.dataset.region = region; button.textContent = region; button.addEventListener('click', () => { newProjectData.region = region; showProjectStep(2); }); container.appendChild(button); }); }
                backProjectBtn.addEventListener('click', () => { if (currentProjectStep > 0) showProjectStep(currentProjectStep - 1); });
                document.getElementById('addProjectForm').addEventListener('submit', (e) => { e.preventDefault(); const projectName = document.getElementById('newProjectName').value.trim(); if (!projectName) { alert('الرجاء إدخال اسم للمشروع.'); return; } const newProject = { id: Date.now(), name: projectName, type: newProjectData.type, region: newProjectData.region, status: currentProjectStatus, docs: [], completion: 0 }; projects.push(newProject); logActivity('المشاريع', projectName, 'إضافة', `تمت إضافة مشروع جديد ضمن "${currentProjectStatus}"`); renderProjectDetails(); document.getElementById('addProjectModal').classList.add('hidden'); });
                document.getElementById('addCategoryForm').addEventListener('submit', (e) => { e.preventDefault(); const name = document.getElementById('newCategoryName').value.trim(); const icon = document.getElementById('newCategoryIcon').value.trim(); if(name && icon) { const key = name; if (!projTypeMeta[key]) { projTypeMeta[key] = {name, icon}; logActivity('إعدادات المشاريع', name, 'إضافة فئة', `فئة جديدة: ${name}`); renderProjectDetails(); document.getElementById('addCategoryModal').classList.add('hidden'); } else { alert('هذه الفئة موجودة بالفعل.'); } } else { alert('يرجى تعبئة جميع الحقول.'); } });
                document.getElementById('addRegionForm').addEventListener('submit', (e) => { e.preventDefault(); const newRegion = document.getElementById('newRegionName').value.trim(); if (newRegion && !availableRegions.includes(newRegion)) { availableRegions.push(newRegion); logActivity('إعدادات المشاريع', newRegion, 'إضافة منطقة', `منطقة جديدة: ${newRegion}`); renderRegionFilters('detail-region-filter'); document.getElementById('detail-region-filter').value = newRegion; document.getElementById('addRegionModal').classList.add('hidden'); } else if (availableRegions.includes(newRegion)) { alert('هذه المنطقة موجودة بالفعل.'); } else { alert('الرجاء إدخال اسم المنطقة.'); } });
                function renderRegionFilters(selectId) { const regionFilter = document.getElementById(selectId); if (!regionFilter) return; const currentVal = regionFilter.value; regionFilter.innerHTML = '<option value="all">كل المناطق</option>' + availableRegions.map(r => `<option value="${r}">${r}</option>`).join(''); regionFilter.value = currentVal; }
                document.querySelectorAll('.close-modal').forEach(btn => btn.addEventListener('click', (e) => e.target.closest('.modal-backdrop').classList.add('hidden')));
                function populateSelect(selectEl, options) { if(selectEl) selectEl.innerHTML = options.map(opt => `<option value="${opt}">${opt}</option>`).join(''); }

                // Initial setup calls
                logActivity('النظام', 'تسجيل الدخول', 'مصادقة', 'تم تسجيل دخول المستخدم بنجاح');
                document.getElementById('home-user-name').textContent = currentUser.name;
                document.getElementById('home-user-role').textContent = currentUser.role;
                showPage('home');
                populateSelect(document.getElementById('boqItemCategory'), availableCategories);
                populateSelect(document.getElementById('boqItemSpecialization'), availableSpecializations);
                populateSelect(document.getElementById('boqTemplateCategory'), availableCategories);
                populateSelect(document.getElementById('boqTemplateSpecialization'), availableSpecializations);
            }
        });
    </script>
</body>
</html>
